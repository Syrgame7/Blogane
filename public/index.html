<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blogane Diamond</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #05050a; --panel: rgba(20, 20, 30, 0.85); --primary: #7c3aed; --accent: #d946ef; 
            --gold: #f59e0b; --text: #ffffff; --gray: #9ca3af; --glass: blur(18px); 
            --border: 1px solid rgba(255, 255, 255, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); 
            background-image: radial-gradient(circle at 0% 0%, #4c1d95 0%, transparent 40%), radial-gradient(circle at 100% 100%, #be185d 0%, transparent 40%);
            color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* Core UI */
        .btn { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; padding: 10px 20px; border-radius: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4); font-size: 14px; }
        .btn:active { transform: scale(0.95); }
        .card { background: var(--panel); backdrop-filter: var(--glass); border: var(--border); border-radius: 24px; padding: 18px; margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .input-box { width: 100%; background: rgba(0,0,0,0.4); border: var(--border); padding: 14px; border-radius: 16px; color: white; outline: none; font-size: 14px; transition: 0.3s; }
        .input-box:focus { border-color: var(--primary); background: rgba(0,0,0,0.6); }
        .avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); box-shadow: 0 0 10px rgba(124, 58, 237, 0.4); }

        /* Floating 'B' Button (Coin Generator) */
        .floating-b {
            position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px;
            background: linear-gradient(135deg, var(--gold), #b45309);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 28px; font-weight: 900; color: white; box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
            z-index: 1000; cursor: pointer; animation: float 3s ease-in-out infinite;
            border: 2px solid rgba(255,255,255,0.5);
        }
        .floating-b.disabled { filter: grayscale(1); animation: none; cursor: default; }
        .b-timer { position: absolute; bottom: -20px; font-size: 10px; background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 5px; display: none; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* Floating Ticker */
        .floating-ticker {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%) translateY(-100px);
            width: 85%; max-width: 380px; height: 45px;
            background: linear-gradient(135deg, #6366f1, #3b82f6);
            border-radius: 30px; z-index: 2000; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6); border: 1px solid rgba(255,255,255,0.3);
            transition: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); opacity: 0;
        }
        .floating-ticker.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .ticker-content { display: flex; align-items: center; gap: 10px; color: white; font-weight: bold; font-size: 13px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        /* Nav & Header */
        .bottom-nav { height: 80px; background: rgba(15, 15, 20, 0.95); backdrop-filter: blur(20px); display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; width: 100%; z-index: 500; border-top: var(--border); padding-bottom: 5px; border-radius: 25px 25px 0 0; }
        .nav-item { color: var(--gray); font-size: 24px; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-8px); text-shadow: 0 0 15px var(--primary); }
        .badge { position: absolute; top: -5px; right: -8px; background: var(--accent); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; display: none; }
        .header { padding: 15px 20px; background: rgba(15, 15, 20, 0.85); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: var(--border); }

        /* Views */
        .view { display: none; height: 100%; overflow-y: auto; padding-bottom: 100px; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        /* Gifts */
        .gift-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; max-height: 350px; overflow-y: auto; }
        .gift-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 12px; text-align: center; cursor: pointer; border: 1px solid transparent; font-size: 11px; transition: 0.2s; }
        .gift-item:hover { border-color: var(--gold); background: rgba(251, 191, 36, 0.15); transform: scale(1.05); }
        .gift-emoji { font-size: 26px; display: block; margin-bottom: 2px; }

        /* Games */
        .game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
        .game-card { background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border-radius: 20px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.3s; }
        .game-card:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .game-icon { font-size: 40px; margin-bottom: 10px; display: block; }
        
        /* Reels */
        .reel-item { height: calc(100vh - 80px); background: black; position: relative; scroll-snap-align: start; display: flex; justify-content: center; }
        .reel-actions { position: absolute; right: 10px; bottom: 120px; display: flex; flex-direction: column; gap: 25px; z-index: 10; }
        .r-btn { display: flex; flex-direction: column; align-items: center; color: white; text-shadow: 1px 1px 2px black; cursor: pointer; }
        .r-btn i { font-size: 30px; margin-bottom: 5px; }
        .reel-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); pointer-events: none; }
        
        /* Chat & Profile */
        .msg-bubble { padding: 10px 16px; border-radius: 20px; max-width: 75%; margin-bottom: 8px; font-size: 14px; line-height: 1.5; }
        .msg-me { background: var(--primary); align-self: flex-start; }
        .msg-other { background: #334155; align-self: flex-end; }
        .profile-cover { height: 180px; background: linear-gradient(45deg, var(--primary), var(--accent)); border-radius: 0 0 35px 35px; position: relative; margin-bottom: 65px; }
        .profile-pic-lg { width: 115px; height: 115px; border-radius: 50%; border: 5px solid var(--bg); position: absolute; bottom: -55px; right: 50%; transform: translateX(50%); object-fit: cover; }
        
        /* Loaders & Modals */
        .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #16161a; width: 90%; max-width: 400px; padding: 25px; border-radius: 24px; border: var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .coins-badge { background: rgba(251, 191, 36, 0.15); color: var(--gold); padding: 6px 14px; border-radius: 20px; font-size: 14px; font-weight: bold; border: 1px solid rgba(251, 191, 36, 0.5); display: flex; align-items: center; gap: 6px; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(16, 185, 129, 0.95); color: white; padding: 12px 20px; border-radius: 30px; z-index: 3000; transition: 0.4s; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .post-img { width: 100%; border-radius: 12px; margin-top: 10px; max-height: 450px; object-fit: cover; }
        .actions { display: flex; gap: 25px; margin-top: 15px; padding-top: 12px; border-top: var(--border); color: var(--gray); }
        .act-btn { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .liked { color: var(--accent); }
        .comments-area { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

    <audio id="snd-start" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
    <audio id="snd-msg" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="snd-coin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
    <audio id="snd-ticker" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>

    <!-- Floating B -->
    <div id="floating-b" class="floating-b" onclick="claimBonus()">B<div class="b-timer" id="b-timer"></div></div>
    
    <div id="gift-ticker" class="floating-ticker"><div class="ticker-content" id="ticker-text"></div></div>
    <div id="toast" class="toast"><i class="fas fa-bell"></i> <span id="toast-msg"></span></div>
    <div class="loader-overlay" id="loader"><div class="spinner"></div><p style="margin-top:15px; color:white">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>

    <!-- Auth -->
    <div id="auth-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box" style="text-align: center;">
            <h1 style="font-size:38px; background: linear-gradient(to right, #a855f7, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; margin-bottom: 10px;">Blogane</h1>
            <div id="reg-fields" style="display:none"><input id="reg-name" class="input-box" placeholder="Ø§Ù„Ø§Ø³Ù…" style="margin-bottom:10px"></div>
            <input id="email" class="input-box" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="margin-bottom:10px">
            <input id="pass" type="password" class="input-box" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom:15px">
            <button class="btn" style="width:100%" onclick="auth()">Ø¯Ø®ÙˆÙ„</button>
            <p style="margin-top:20px; cursor:pointer; color:var(--gray)" onclick="toggleAuth()">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ</p>
        </div>
    </div>

    <div class="modal-overlay" id="generic-modal"><div class="modal-box" id="modal-content"></div></div>

    <!-- VIEW 1: HOME -->
    <div id="view-home" class="view active">
        <div class="header">
            <div class="coins-badge"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
            <img src="" id="header-avatar" class="avatar" onclick="openProfile(currentUser.email)">
        </div>
        <div id="ctx-banner" style="display:none; padding:15px; background:linear-gradient(to right, var(--primary), var(--accent)); text-align:center;">
            <h3 id="ctx-title" style="color:white;"></h3>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px"><button id="ctx-del" class="btn" style="background:#ef4444; font-size:12px; display:none" onclick="deleteContext()">Ø­Ø°Ù</button><button class="btn" style="background:rgba(0,0,0,0.3); font-size:12px" onclick="leaveContext()">Ø®Ø±ÙˆØ¬</button></div>
        </div>
        <div style="padding: 15px;">
            <div class="card">
                <div style="display:flex; gap:10px"><img src="" id="my-avatar" class="avatar"><input id="post-txt" class="input-box" style="border-radius:25px; border:none; background:rgba(255,255,255,0.05)" placeholder="Ø¨Ù…Ø§Ø°Ø§ ØªÙÙƒØ±ØŸ"></div>
                <div style="display:flex; justify-content:space-between; margin-top:15px"><label style="color:#10b981; cursor:pointer; display:flex; align-items:center; gap:5px"><i class="fas fa-image"></i> ØµÙˆØ±Ø©<input type="file" id="post-img" hidden></label><button class="btn" onclick="publishPost()">Ù†Ø´Ø±</button></div>
            </div>
            <div id="feed"></div>
        </div>
    </div>

    <!-- VIEW 2: EXPLORE (With Games) -->
    <div id="view-explore" class="view">
        <div class="header"><h2>Ø§Ø³ØªÙƒØ´Ù</h2></div>
        <div style="padding: 15px;">
            <div class="card" onclick="navTo('games')" style="background:linear-gradient(45deg, #8b5cf6, #3b82f6); cursor:pointer; text-align:center; padding:20px"><h2 style="margin-bottom:5px">ğŸ® ØµØ§Ù„Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h2><p>Ø§Ù„Ø¹Ø¨ ÙˆØ§Ø±Ø¨Ø­ Ø§Ù„ÙƒÙˆÙŠÙ†Ø²!</p></div>
            <div class="card"><h4 style="margin-bottom:10px; color:var(--accent)">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© <span id="req-badge-count" style="background:var(--primary); padding:2px 6px; border-radius:5px; font-size:11px; color:white">0</span></h4><div id="req-list"></div><div style="display:flex; gap:10px; margin-top:10px"><input id="friend-email" class="input-box" style="margin:0" placeholder="Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„ØµØ¯ÙŠÙ‚"><button class="btn" onclick="addFriend()"><i class="fas fa-plus"></i></button></div></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px"><button class="btn" style="background:#334155" onclick="promptCreate('group')">Ù…Ø¬Ù…ÙˆØ¹Ø© +</button><button class="btn" style="background:#334155" onclick="promptCreate('page')">ØµÙØ­Ø© +</button></div>
            <h4 style="color:var(--gray); margin-bottom:10px">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h4><div id="groups-list"></div><h4 style="color:var(--gray); margin:20px 0 10px">Ø§Ù„ØµÙØ­Ø§Øª</h4><div id="pages-list"></div>
        </div>
    </div>

    <!-- VIEW 3: GAMES -->
    <div id="view-games" class="view">
        <div class="header"><h2>Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ğŸ®</h2><button class="btn" onclick="navTo('explore')">Ø¹ÙˆØ¯Ø©</button></div>
        <div class="game-grid">
            <div class="game-card" onclick="playGame('wheel')"><span class="game-icon">ğŸ¡</span><h3>Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸</h3><p>Ø¬Ø±Ø¨ Ø­Ø¸Ùƒ!</p></div>
            <div class="game-card" onclick="playGame('guess')"><span class="game-icon">â“</span><h3>ØªØ®Ù…ÙŠÙ† Ø§Ù„Ø±Ù‚Ù…</h3><p>Ù…Ù† 1 Ø¥Ù„Ù‰ 10</p></div>
            <div class="game-card" onclick="playGame('scratch')"><span class="game-icon">ğŸ«</span><h3>Ø¨Ø·Ø§Ù‚Ø© Ø­Ùƒ</h3><p>Ø§Ø±Ø¨Ø­ ÙÙˆØ±Ø§Ù‹</p></div>
            <div class="game-card" onclick="playGame('slots')"><span class="game-icon">ğŸ°</span><h3>Ø³Ù„ÙˆØªØ³</h3><p>Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø´ÙƒØ§Ù„</p></div>
        </div>
    </div>

    <!-- VIEW 4: REELS -->
    <div id="view-reels" class="view" style="background: black;"><div style="position:absolute; top:20px; left:20px; z-index:100"><button class="btn" style="background:rgba(255,255,255,0.2); backdrop-filter:blur(5px)" onclick="showReelModal()">+</button></div><div id="reels-container" style="height:100%; overflow-y:scroll; scroll-snap-type:y mandatory"></div></div>

    <!-- VIEW 5: CHAT -->
    <div id="view-chat" class="view">
        <div class="header"><h2>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2></div>
        <div class="chat-tabs"><button class="btn" style="flex:1;background:#333" onclick="switchChat('global')">Ø¹Ø§Ù…Ø©</button><button class="btn" style="flex:1;background:#333" onclick="switchChat('private')">Ø®Ø§Øµ</button><button class="btn" style="flex:1;background:#333" onclick="switchChat('ai')">AI</button></div>
        <div id="chat-global" style="height:calc(100% - 130px); display:flex; flex-direction:column"><div id="g-msgs" style="flex:1; overflow-y:auto; padding:10px"></div><div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="g-input" class="input-box" style="margin:0" placeholder="Ø§ÙƒØªØ¨..."><button class="btn" onclick="sendGlobal()">â¤</button></div></div>
        <div id="chat-private" style="height:calc(100% - 130px); display:none; flex-direction:column"><div id="friends-list" style="flex:1; overflow-y:auto; padding:10px"></div><div id="priv-conv" style="display:none; height:100%; flex-direction:column"><div style="padding:10px; display:flex; justify-content:space-between"><button class="btn" onclick="closePriv()">Ø¹ÙˆØ¯Ø©</button> <button class="btn" style="background:var(--gold);color:black" onclick="showGifts()">ğŸ</button></div><div id="p-msgs" style="flex:1; overflow-y:auto; padding:10px"></div><div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="p-input" class="input-box" style="margin:0" placeholder="Ø®Ø§Øµ..."><button class="btn" onclick="sendPriv()">â¤</button></div></div></div>
        <div id="chat-ai" style="height:calc(100% - 130px); display:none; flex-direction:column"><div id="ai-msgs" style="flex:1; overflow-y:auto; padding:10px"></div><div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="ai-input" class="input-box" style="margin:0" placeholder="Ø§Ø³Ø£Ù„ AI..."><button class="btn" onclick="sendAi()">â¤</button></div></div>
    </div>

    <!-- VIEW 6: PROFILE -->
    <div id="view-profile" class="view"><div id="profile-content"></div></div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i></div>
        <div class="nav-item" onclick="navTo('explore', this)"><i class="fas fa-compass"></i><div class="badge" id="nav-req-badge" style="display:none">0</div></div>
        <div class="nav-item" onclick="navTo('reels', this)"><i class="fas fa-play-circle" style="color:var(--accent)"></i></div>
        <div class="nav-item" onclick="navTo('chat', this)"><i class="fas fa-comments"></i><div class="badge" id="nav-msg-badge" style="display:none">!</div></div>
        <div class="nav-item" onclick="openProfile(currentUser.email, this)"><i class="fas fa-user"></i></div>
    </nav>

    <!-- Gift Modal (100 Gifts) -->
    <div id="gift-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box" style="max-height: 80%;">
            <h3 style="text-align:center; color:var(--gold)">Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (100) ğŸ</h3>
            <p style="text-align:center; font-size:12px; color:var(--gray)">Ø±ØµÙŠØ¯Ùƒ: <span id="gift-balance">0</span></p>
            <div class="gift-grid" id="gift-grid-content"></div>
            <button class="btn" style="width:100%; background:#333; margin-top:10px" onclick="document.getElementById('gift-modal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        const socket = io();
        let currentUser = null, currentContext = 'general', currentContextId = null, currentPriv = null, isReg = false;
        
        // --- 100 Gifts Generation ---
        const emojis = ["ğŸŒ¹","â¤ï¸","ğŸ”¥","ğŸ","ğŸ’","ğŸ‘‘","ğŸ†","ğŸ¥‡","ğŸï¸","âœˆï¸","ğŸ°","ğŸ¦","ğŸ¯","ğŸ¦„","ğŸ‰","ğŸª","ğŸš€","ğŸ¸","ğŸ¹","ğŸº","ğŸ»","ğŸ¤","ğŸ§","ğŸ¨","ğŸ¬","ğŸ­","ğŸª","ğŸ¢","ğŸ¡","ğŸ ","ğŸ–ï¸","ğŸï¸","ğŸŒ‹","ğŸ”ï¸","ğŸ•ï¸","â›º","ğŸ ","ğŸ¡","ğŸ¢","ğŸ£","ğŸ¤","ğŸ¥","ğŸ¦","ğŸ¨","ğŸ©","ğŸª","ğŸ«","ğŸ¬","ğŸ­","ğŸ¯","ğŸ°","ğŸ’’","ğŸ—¼","ğŸ—½","â›ª","ğŸ•Œ","ğŸ›•","ğŸ•","â›©ï¸","ğŸ•‹","â›²","â›º","ğŸŒ","ğŸŒƒ","ğŸ™ï¸","ğŸŒ„","ğŸŒ…","ğŸŒ†","ğŸŒ‡","ğŸŒ‰","â™¨ï¸","ğŸ ","ğŸ¡","ğŸ¢","ğŸ’ˆ","circus","ğŸš‚","ğŸšƒ","ğŸš„","ğŸš…","ğŸš†","ğŸš‡","ğŸšˆ","ğŸš‰","ğŸšŠ","ğŸš","ğŸš","Tram","ğŸšŒ","ğŸš","ğŸš","ğŸš","ğŸš‘","ğŸš’","ğŸš“","ğŸš”","ğŸš•","ğŸš–","ğŸš—","ğŸš˜","ğŸš™","ğŸšš","ğŸš›","ğŸšœ"];
        const giftHTML = emojis.map((e, i) => {
            const price = (i + 1) * 10;
            return `<div class="gift-item" onclick="sendGift('Gift ${i+1}',${price},'${e}')"><span class="gift-emoji">${e}</span><br>${price}</div>`;
        }).join('');
        document.getElementById('gift-grid-content').innerHTML = giftHTML;

        // --- Floating B Button Logic ---
        let bCooldown = 0;
        function updateB() {
            const btn = document.getElementById('floating-b');
            const timer = document.getElementById('b-timer');
            const now = Date.now();
            const savedTime = localStorage.getItem('b_last_claim');
            const lastClaim = savedTime ? parseInt(savedTime) : 0;
            const diff = now - lastClaim;
            const waitTime = 10 * 60 * 1000; // 10 minutes

            if (diff >= waitTime) {
                btn.classList.remove('disabled');
                timer.style.display = 'none';
            } else {
                btn.classList.add('disabled');
                timer.style.display = 'block';
                const left = Math.ceil((waitTime - diff) / 60000);
                timer.innerText = left + 'm';
            }
        }
        setInterval(updateB, 1000);
        
        function claimBonus() {
            const btn = document.getElementById('floating-b');
            if (!btn.classList.contains('disabled')) {
                localStorage.setItem('b_last_claim', Date.now());
                socket.emit('claim_bonus', currentUser.email);
                updateB();
            }
        }

        // --- Games Logic (Simulation) ---
        function playGame(game) {
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù„Ø¹Ø¨ ' + game + 'ØŸ (Ù…Ø¬Ø§Ù†ÙŠ)')) {
                showLoader('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù„Ø¹Ø¨...');
                setTimeout(() => {
                    hideLoader();
                    const score = Math.floor(Math.random() * 100);
                    socket.emit('play_game', {email: currentUser.email, game: game, score: score});
                }, 2000);
            }
        }

        // --- Standard Logic (Same as previous but optimized) ---
        // Ticker
        socket.on('gift_broadcast', (d) => {
            const tick = document.getElementById('gift-ticker');
            document.getElementById('ticker-text').innerHTML = `<img src="${d.avatar}" style="width:20px;border-radius:50%"> ${d.from} Ø£Ø±Ø³Ù„ ${d.gift} Ø¥Ù„Ù‰ ${d.to}`;
            tick.classList.add('show'); document.getElementById('snd-ticker').play().catch(()=>{});
            setTimeout(()=>tick.classList.remove('show'), 5000);
        });

        function notify(t, b) { const el=document.getElementById('toast'); document.getElementById('toast-msg').innerHTML=`<b>${t}</b><br>${b}`; el.classList.add('show'); document.getElementById('snd-msg').play().catch(()=>{}); setTimeout(()=>el.classList.remove('show'), 3000); }

        window.onload = () => { 
            const s=localStorage.getItem('u'); 
            if(s) socket.emit('login', JSON.parse(s)); 
            else { hideLoader(); document.getElementById('auth-modal').style.display='flex'; }
            updateB();
        }

        function navTo(v, el) { 
            document.getElementById('snd-click').play().catch(()=>{});
            document.querySelectorAll('.view').forEach(x=>x.classList.remove('active')); 
            document.getElementById('view-'+v).classList.add('active'); 
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); 
            if(el) el.classList.add('active');
            if(v==='chat') document.getElementById('nav-msg-badge').style.display='none';
            if(v==='profile' && currentUser) socket.emit('get_profile_info', currentUser.email);
        }

        function showLoader(t){ document.getElementById('loader').style.display='flex'; }
        function hideLoader(){ document.getElementById('loader').style.display='none'; }
        function showModal(h){ document.getElementById('modal-content').innerHTML=h; document.getElementById('generic-modal').style.display='flex'; }
        function closeModal(){ document.getElementById('generic-modal').style.display='none'; }

        function toggleAuth(){ isReg=!isReg; document.getElementById('reg-fields').style.display=isReg?'block':'none'; }
        function auth(){ const e=document.getElementById('email').value, p=document.getElementById('pass').value; if(isReg) socket.emit('register', {name:document.getElementById('reg-name').value, email:e, password:p}); else socket.emit('login', {email:e, password:p}); }
        socket.on('auth_success', (u)=>{ 
            currentUser=u; localStorage.setItem('u', JSON.stringify({email:u.email, password:u.password})); 
            document.getElementById('auth-modal').style.display='none'; hideLoader(); document.getElementById('snd-start').play().catch(()=>{}); updateMyUI(); 
            navTo('home', document.querySelector('.nav-item'));
        });
        function updateMyUI(){ document.getElementById('my-avatar').src=currentUser.avatar; document.getElementById('header-avatar').src=currentUser.avatar; document.getElementById('user-coins').innerText=currentUser.coins; }

        // Functions to save space (reused from previous stable versions)
        window.openProfile = (e, el) => { if(el) navTo('profile', el); else navTo('profile'); showLoader('..'); socket.emit('get_profile_info', e); }
        socket.on('open_profile_view', ({user, posts, friends}) => {
            hideLoader();
            document.getElementById('profile-content').innerHTML = `
                <div class="profile-cover"><img src="${user.avatar}" class="profile-pic-lg"></div>
                <div style="text-align:center;padding-top:60px"><h2>${user.name}</h2><p style="color:var(--gray)">${user.bio||''}</p>
                <div style="margin-top:15px">${user.email===currentUser.email ? `<button class="btn" style="background:rgba(255,255,255,0.1)" onclick="showEditProfile()">ØªØ¹Ø¯ÙŠÙ„</button>` : `<button class="btn" onclick="socket.emit('send_friend_request', {from:currentUser.email, to:'${user.email}'}); alert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„')">ØµØ¯Ø§Ù‚Ø©</button> <button class="btn" style="background:var(--accent)" onclick="startChat('${user.email}','${user.name}')">Ù…Ø±Ø§Ø³Ù„Ø©</button>`}</div></div>
                <div style="padding:15px"><h4 style="color:var(--accent)">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h4><div style="display:flex;flex-wrap:wrap">${friends?friends.map(f=>`<div class="friend-chip" onclick="openProfile('${f.email}')"><img src="${f.avatar}" style="width:20px;height:20px;border-radius:50%">${f.name}</div>`).join(''):''}</div><h3 style="margin-top:15px;color:var(--primary);border-bottom:var(--border)">Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h3>${posts.map(p=>`<div class="card"><p>${p.content||'ØµÙˆØ±Ø©'}</p></div>`).join('')}</div>`;
        });
        function showEditProfile(){ showModal(`<h3>ØªØ¹Ø¯ÙŠÙ„</h3><input type="file" id="edit-img" class="input-box"><input id="e-n" class="input-box" value="${currentUser.name}"><input id="e-b" class="input-box" value="${currentUser.bio||''}" placeholder="Ø§Ù„Ù†Ø¨Ø°Ø©"><button class="btn" onclick="saveP()">Ø­ÙØ¸</button><button class="btn" style="background:none" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>`); }
        function saveP(){ const n=document.getElementById('e-n').value, b=document.getElementById('e-b').value, f=document.getElementById('edit-img').files[0]; const d={email:currentUser.email,name:n,bio:b}; if(f){const r=new FileReader();r.onload=(e)=>{d.avatar=e.target.result;socket.emit('update_profile',d);};r.readAsDataURL(f);}else socket.emit('update_profile',d); closeModal(); }
        socket.on('profile_updated_success', (u)=>{ currentUser=u; updateMyUI(); openProfile(u.email); });

        let postImg=null; document.getElementById('post-img').addEventListener('change', function(){ const f=this.files[0]; if(f){const r=new FileReader(); r.onload=(e)=>{postImg=e.target.result;}; r.readAsDataURL(f);} });
        function publishPost(){ const t=document.getElementById('post-txt').value; if(t||postImg){ showLoader('Ù†Ø´Ø±...'); socket.emit('new_post', {content:t, media:postImg, author:currentUser.name, email:currentUser.email, avatar:currentUser.avatar, context:currentContext, contextId:currentContextId}); document.getElementById('post-txt').value=''; postImg=null; } }
        socket.on('upload_complete', hideLoader);
        socket.on('receive_post', (p)=> { if(p.context===currentContext && p.contextId===currentContextId) renderPost(p,'feed'); });
        socket.on('load_posts', (ps)=> { document.getElementById('feed').innerHTML=''; ps.reverse().forEach(p=>renderPost(p,'feed')); });
        function renderPost(p, t) {
            const l = p.likes.includes(currentUser.email);
            const html = `<div class="card"><div style="display:flex;gap:10px;align-items:center;cursor:pointer" onclick="openProfile('${p.email}')"><img src="${p.avatar}" class="avatar"><div><b>${p.author}</b><br><small style="color:var(--gray); font-size:11px">${new Date(p.date).toLocaleTimeString()}</small></div></div><p style="margin-top:10px; line-height:1.5">${p.content||''}</p>${p.media?`<img src="${p.media}" class="post-img">`:''}<div class="actions"><div class="act-btn ${l?'liked':''}" onclick="socket.emit('toggle_like',{id:${p.id},type:'post',userEmail:currentUser.email})"><i class="${l?'fas':'far'} fa-heart"></i> <span id="l-${p.id}">${p.likes.length}</span></div><div class="act-btn" onclick="toggleC(${p.id})"><i class="far fa-comment"></i> <span>${p.comments.length}</span></div></div><div class="comments-area" id="com-${p.id}"><div id="clist-${p.id}">${p.comments.map(c=>`<div class="comment-item"><img src="${c.userAvatar}" class="avatar" style="width:25px;height:25px"><div class="comment-bubble"><b>${c.userName}</b><br>${c.text}</div></div>`).join('')}</div><div style="display:flex; gap:5px; margin-top:10px"><input id="cin-${p.id}" class="input-box" style="padding:8px" placeholder="ØªØ¹Ù„ÙŠÙ‚.."><button class="btn" style="padding:5px 10px" onclick="sendC(${p.id})">â¤</button></div></div></div>`;
            document.getElementById(t).insertAdjacentHTML('afterbegin', html);
        }
        window.toggleC=(id)=>{const e=document.getElementById(`com-${id}`); e.style.display=e.style.display==='block'?'none':'block';}
        window.sendC=(id)=>{const t=document.getElementById(`cin-${id}`).value; if(t){socket.emit('add_comment',{postId:id, text:t, userEmail:currentUser.email, userName:currentUser.name, userAvatar:currentUser.avatar}); document.getElementById(`cin-${id}`).value='';}}
        socket.on('update_comments', (d)=>{ document.getElementById(`clist-${d.postId}`).innerHTML = d.comments.map(c=>`<div class="comment-item"><img src="${c.userAvatar}" class="avatar" style="width:25px;height:25px"><div class="comment-bubble"><b>${c.userName}</b><br>${c.text}</div></div>`).join(''); });
        socket.on('update_likes', (d)=>{ const e=document.getElementById(`l-${d.id}`); if(e)e.innerText=d.likes.length; });

        function switchChat(t) { ['global','private','ai'].forEach(x=>document.getElementById(`chat-${x}`).style.display=x===t?'flex':'none'); document.querySelectorAll('.chat-tab').forEach(x=>x.classList.remove('active')); document.getElementById(`tab-${t}`).classList.add('active'); }
        function sendGlobal(){ const t=document.getElementById('g-input').value; if(t){socket.emit('send_global_msg',{text:t,author:currentUser.name,email:currentUser.email,avatar:currentUser.avatar});document.getElementById('g-input').value='';} }
        socket.on('receive_global_msg', (m)=>{ const me=m.email===currentUser.email; document.getElementById('g-msgs').innerHTML+=`<div style="display:flex;flex-direction:column;align-items:${me?'flex-start':'flex-end'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}" onclick="openProfile('${m.email}')"><b>${me?'':m.author+':'}</b> ${m.text}</div></div>`; });
        function sendAi(){ const t=document.getElementById('ai-input').value; if(t){ document.getElementById('ai-msgs').innerHTML+=`<div class="msg-bubble msg-me">${t}</div>`; socket.emit('send_ai_msg',t); document.getElementById('ai-input').value=''; } }
        socket.on('receive_ai_msg', (m)=>{ document.getElementById('ai-msgs').innerHTML+=`<div class="msg-bubble msg-other">${m.text}</div>`; });
        socket.on('update_friends', (f) => { document.getElementById('friends-list').innerHTML = f.map(u => `<div class="friend-item" onclick="startChat('${u.email}','${u.name}')"><img src="${u.avatar}" class="avatar"> <div><b>${u.name}</b><br><small style="color:${u.isOnline?'#10b981':'#aaa'}">${u.isOnline?'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†':'ØºÙŠØ± Ù…ØªØµÙ„'}</small></div></div>`).join(''); });
        window.startChat = (e, n) => { currentPriv=e; navTo('chat'); switchChat('private'); document.getElementById('friends-list').style.display='none'; document.getElementById('priv-conv').style.display='flex'; document.getElementById('p-name-header').innerText=n; document.getElementById('p-msgs').innerHTML=''; socket.emit('get_private_msgs',{u1:currentUser.email, u2:e}); }
        function closePriv(){ document.getElementById('priv-conv').style.display='none'; document.getElementById('friends-list').style.display='block'; currentPriv=null; }
        function sendPriv(){ const t=document.getElementById('p-input').value; if(t){ socket.emit('send_private_msg',{from:currentUser.email, to:currentPriv, text:t}); document.getElementById('p-input').value=''; } }
        socket.on('load_private_msgs', (ms)=>{ document.getElementById('p-msgs').innerHTML = ms.map(m=> { const me=m.from===currentUser.email; const c=m.isGift?`<div style="text-align:center;background:#d97706;padding:10px;border-radius:10px;border:1px solid #fbbf24"><div style="font-size:30px">${m.icon}</div>${m.text}</div>`:m.text; return `<div style="display:flex;flex-direction:column;align-items:${me?'flex-start':'flex-end'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}">${c}</div></div>`; }).join(''); });
        socket.on('receive_private_msg', (m)=>{ if(m.from===currentPriv || m.from===currentUser.email) { const me=m.from===currentUser.email; const c=m.isGift?`<div style="text-align:center;background:#d97706;padding:10px;border-radius:10px;border:1px solid #fbbf24"><div style="font-size:30px">${m.icon}</div>${m.text}</div>`:m.text; document.getElementById('p-msgs').innerHTML+=`<div style="display:flex;flex-direction:column;align-items:${me?'flex-start':'flex-end'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}">${c}</div></div>`; document.getElementById('p-msgs').scrollTop=document.getElementById('p-msgs').scrollHeight; document.getElementById('snd-msg').play().catch(()=>{}); } else { document.getElementById('nav-msg-badge').style.display='block'; notify('Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©','Ù„Ø¯ÙŠÙƒ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©'); } });
        function showGifts(){ document.getElementById('gift-balance').innerText=currentUser.coins; document.getElementById('gift-modal').style.display='flex'; }
        function sendGift(n, c, i){ if(currentUser.coins<c){notify('Ø®Ø·Ø£','Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ');return;} socket.emit('send_gift',{from:currentUser.email, to:currentPriv, giftName:n, cost:c, icon:i}); document.getElementById('gift-modal').style.display='none'; }
        socket.on('update_coins', (c)=>{ currentUser.coins=c; document.getElementById('user-coins').innerText=c; document.getElementById('snd-coin').play().catch(()=>{}); });

        function addFriend(){ socket.emit('send_friend_request', {from:currentUser.email, to:document.getElementById('friend-email').value}); document.getElementById('friend-email').value=''; alert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); }
        function promptCreate(t){ const n=prompt('Ø§Ù„Ø§Ø³Ù…:'); if(n) t==='group'?socket.emit('create_group',{name:n,desc:'',owner:currentUser.email}):socket.emit('create_page',{name:n,owner:currentUser.email}); }
        socket.on('update_groups', (gs) => { document.getElementById('groups-list').innerHTML = gs.map(g=>`<div class="card" style="padding:10px; cursor:pointer" onclick="enterContext('group','${g.id}','${g.name}','${g.owner}')"><b>${g.name}</b></div>`).join(''); });
        socket.on('update_pages', (ps) => { document.getElementById('pages-list').innerHTML = ps.map(p=>`<div class="card" style="padding:10px; cursor:pointer" onclick="enterContext('page','${p.id}','${p.name}','${p.owner}')"><b>${p.name}</b></div>`).join(''); });
        socket.on('update_requests', (reqs) => { document.getElementById('req-badge-count').innerText = reqs.length; document.getElementById('nav-req-badge').style.display = reqs.length?'block':'none'; document.getElementById('req-list').innerHTML = reqs.map(r => `<div class="card" style="padding:10px;display:flex;justify-content:space-between;align-items:center"><div style="display:flex;gap:10px"><img src="${r.avatar}" class="avatar" style="width:30px;height:30px"> ${r.name}</div><button class="btn" style="font-size:10px;padding:5px" onclick="socket.emit('respond_friend_request',{userEmail:currentUser.email, requesterEmail:'${r.email}', accept:true})">Ù‚Ø¨ÙˆÙ„</button></div>`).join(''); });
        function enterContext(t,i,n,o){ currentContext=t;currentContextId=i; navTo('home'); document.getElementById('ctx-banner').style.display='block'; document.getElementById('ctx-title').innerText=n; document.getElementById('feed').innerHTML=''; socket.emit('get_context_posts',{context:t,contextId:i}); document.getElementById('ctx-del').style.display=(currentUser.email===o?'inline-block':'none'); }
        function leaveContext(){ currentContext='general';currentContextId=null; document.getElementById('ctx-banner').style.display='none'; document.getElementById('feed').innerHTML=''; socket.emit('get_context_posts',{context:'general',contextId:null}); }
        function deleteContext(){ if(confirm('Ø­Ø°ÙØŸ')){ if(currentContext==='group')socket.emit('delete_group',{groupId:currentContextId,email:currentUser.email}); else socket.emit('delete_page',{pageId:currentContextId,email:currentUser.email}); } }
        socket.on('delete_success', ()=>{ alert('ØªÙ… Ø§Ù„Ø­Ø°Ù'); leaveContext(); });

        socket.on('init_data', (d) => {
            document.getElementById('groups-list').innerHTML = d.groups.map(g=>`<div class="card" style="padding:10px; cursor:pointer" onclick="enterContext('group','${g.id}','${g.name}','${g.owner}')"><b>${g.name}</b></div>`).join('');
            document.getElementById('pages-list').innerHTML = d.pages.map(p=>`<div class="card" style="padding:10px; cursor:pointer" onclick="enterContext('page','${p.id}','${p.name}','${p.owner}')"><b>${p.name}</b></div>`).join('');
            document.getElementById('req-badge-count').innerText = (d.friendRequests||[]).length;
            d.globalMessages.forEach(m => { const me=m.email===currentUser.email; document.getElementById('g-msgs').innerHTML+=`<div style="display:flex;flex-direction:column;align-items:${me?'flex-start':'flex-end'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}" onclick="openProfile('${m.email}')"><b>${me?'':m.author+':'}</b> ${m.text}</div></div>`; });
            d.reels.forEach(r => renderReel(r));
        });

        function showReelModal(){ showModal(`<h3>Ù†Ø´Ø± ÙÙŠØ¯ÙŠÙˆ</h3><input type="file" id="r-f" class="input-box" accept="video/*"><input type="text" id="r-d" class="input-box" placeholder="ÙˆØµÙ"><button class="btn" style="width:100%" onclick="uplR()">Ù†Ø´Ø±</button><button class="btn" style="width:100%;background:none" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>`); }
        async function uplR(){ const f=document.getElementById('r-f').files[0], d=document.getElementById('r-d').value; if(!f)return; showLoader('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...'); socket.emit('upload_reel_start', {name:f.name}); const CHUNK=500*1024, total=Math.ceil(f.size/CHUNK); socket.once('upload_ready', async ({tempFileName}) => { for(let i=0; i<total; i++){ socket.emit('upload_reel_chunk', {fileName:tempFileName, data:await f.slice(i*CHUNK,(i+1)*CHUNK).arrayBuffer()}); } socket.emit('upload_reel_end', {fileName:tempFileName, desc:d, author:currentUser.name, avatar:currentUser.avatar, email:currentUser.email}); }); }
        socket.on('receive_reel', (r)=>{ renderReel(r); });
        function renderReel(r) {
            const l = r.likes && r.likes.includes(currentUser.email);
            const h = `
            <div class="reel-item">
                <video src="${r.url}" class="reel-video" loop onclick="this.paused?this.play():this.pause()"></video>
                <div class="reel-actions">
                    <div class="r-btn" onclick="socket.emit('toggle_like_reel',{id:${r.id},userEmail:currentUser.email})">
                        <i class="${l?'fas':'far'} fa-heart" style="color:${l?'red':'white'}" id="rl-icon-${r.id}"></i> <span id="rl-count-${r.id}">${r.likes?r.likes.length:0}</span>
                    </div>
                    <div class="r-btn" onclick="openReelComments(${r.id})">
                        <i class="fas fa-comment-dots"></i> <span id="rc-count-${r.id}">${r.comments?r.comments.length:0}</span>
                    </div>
                </div>
                <div class="reel-overlay"><b>${r.author}</b><br>${r.desc}</div>
                <div id="rc-sheet-${r.id}" class="reel-comments-sheet">
                    <div style="padding:10px;text-align:center;border-bottom:1px solid #333">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª <span onclick="this.parentElement.parentElement.style.display='none'" style="float:left;cursor:pointer">âœ•</span></div>
                    <div id="rc-list-${r.id}" style="flex:1;overflow-y:auto;padding:10px"></div>
                    <div style="padding:10px;display:flex;gap:5px"><input id="rc-in-${r.id}" class="input-box" style="margin:0"><button class="btn" onclick="sendRC(${r.id})">â¤</button></div>
                </div>
            </div>`;
            document.getElementById('reels-container').insertAdjacentHTML('afterbegin', h);
            if(r.comments) document.getElementById(`rc-list-${r.id}`).innerHTML = r.comments.map(c=>`<div class="comment-item"><img src="${c.userAvatar}" class="avatar" style="width:25px;height:25px"><div><b>${c.userName}</b><br>${c.text}</div></div>`).join('');
        }
        window.openReelComments = (id) => document.getElementById(`rc-sheet-${id}`).style.display = 'flex';
        window.sendRC = (id) => { const t=document.getElementById(`rc-in-${id}`).value; if(t){socket.emit('comment_reel',{id, text:t, userEmail:currentUser.email, userName:currentUser.name, userAvatar:currentUser.avatar}); document.getElementById(`rc-in-${id}`).value='';} }
        socket.on('update_reel_stats', (d)=>{ document.getElementById(`rl-count-${d.id}`).innerText = d.likes; document.getElementById(`rc-count-${d.id}`).innerText = d.comments; });
        socket.on('new_reel_comment', (d) => { const l = document.getElementById(`rc-list-${d.reelId}`); if(l) l.innerHTML += `<div class="comment-item"><img src="${d.comment.userAvatar}" class="avatar" style="width:25px;height:25px"><div><b>${d.comment.userName}</b><br>${d.comment.text}</div></div>`; });
    </script>
</body>
</html>
