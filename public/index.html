<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blogane Social</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0f172a;
            --glass: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #8b5cf6;
            --accent: #ec4899;
            --text: #f8fafc;
            --text-gray: #cbd5e1;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        
        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 4px; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 3000;
        }
        .modal-card {
            background: #1e293b; border: 1px solid var(--glass-border);
            padding: 25px; border-radius: 20px; width: 90%; max-width: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 20px; font-weight: bold; }

        /* Auth & Inputs */
        .auth-input {
            width: 100%; padding: 12px; margin: 8px 0;
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            border-radius: 10px; color: white; outline: none;
        }
        .btn-main {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none; padding: 10px 20px; border-radius: 10px;
            color: white; font-weight: bold; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 5px; justify-content: center;
        }
        .btn-main:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px solid var(--glass-border); }

        /* Layout */
        #app-interface { display: none; height: 100vh; flex-direction: column; }
        nav {
            height: 65px; background: var(--glass); border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            backdrop-filter: blur(10px); z-index: 100;
        }
        .container {
            display: grid; grid-template-columns: 260px 1fr 300px; gap: 20px;
            padding: 20px; height: calc(100vh - 65px); max-width: 1500px; margin: 0 auto; width: 100%;
        }
        .panel {
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 15px; overflow-y: auto; height: 100%;
        }

        /* Posts */
        .create-post { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .create-post textarea { width: 100%; background: transparent; border: none; color: white; resize: none; outline: none; font-size: 15px; }
        .media-preview { max-width: 100%; margin-top: 10px; border-radius: 10px; display: none; }
        
        .post { background: rgba(30, 41, 59, 0.6); border-radius: 15px; padding: 15px; margin-bottom: 15px; animation: fadeIn 0.4s; border: 1px solid var(--glass-border); }
        .post-header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .post-img { width: 100%; border-radius: 10px; margin-top: 10px; max-height: 400px; object-fit: cover; }
        .post-actions { display: flex; gap: 20px; padding-top: 10px; margin-top: 10px; border-top: 1px solid var(--glass-border); color: var(--text-gray); }
        .action-btn { cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .action-btn:hover { color: var(--primary); }
        .action-btn.liked { color: #ef4444; }

        /* Comments */
        .comments-section { margin-top: 10px; padding-top: 10px; display: none; }
        .comment { display: flex; gap: 10px; margin-bottom: 10px; font-size: 13px; }
        .comment-bubble { background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 15px; flex: 1; }

        /* Context Header (Group/Page Cover) */
        .context-header { 
            background: linear-gradient(to right, #4f46e5, #9333ea); 
            padding: 30px; border-radius: 15px; margin-bottom: 20px; text-align: center; 
            display: none; /* Hidden by default */
        }

        /* Sidebar Items */
        .menu-item { padding: 12px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-gray); transition: 0.2s; }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .friend-req-card { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 8px; }
        
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .sidebar-left, .sidebar-right { display: none; } }
    </style>
</head>
<body>

    <!-- Auth Screen -->
    <div class="modal-overlay" id="auth-screen" style="display: flex;">
        <div class="modal-card" style="text-align: center;">
            <h1 style="background: linear-gradient(to right, #a855f7, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 40px; margin-bottom: 10px;">Blogane</h1>
            <p style="color: #94a3b8; margin-bottom: 20px;">منصة التواصل المستقبلية</p>
            <div id="auth-forms">
                <input type="text" id="reg-name" class="auth-input" placeholder="الاسم الكامل" style="display: none;">
                <input type="email" id="auth-email" class="auth-input" placeholder="البريد الإلكتروني">
                <input type="password" id="auth-pass" class="auth-input" placeholder="كلمة المرور">
                <button class="btn-main" style="width: 100%; margin-top: 10px;" onclick="login()">دخول</button>
                <p style="margin-top: 15px; font-size: 13px; cursor: pointer; color: var(--primary);" onclick="toggleAuthMode()">ليس لديك حساب؟ إنشاء حساب</p>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div class="modal-overlay" id="edit-profile-modal">
        <div class="modal-card">
            <div class="modal-header">
                <span>تعديل الملف الشخصي</span>
                <span style="cursor: pointer;" onclick="closeModal('edit-profile-modal')">✕</span>
            </div>
            <input type="text" id="edit-name" class="auth-input" placeholder="الاسم الجديد">
            <input type="text" id="edit-bio" class="auth-input" placeholder="نبذة عنك">
            <input type="text" id="edit-avatar" class="auth-input" placeholder="رابط الصورة الرمزية (URL)">
            <button class="btn-main" style="width: 100%;" onclick="saveProfile()">حفظ التغييرات</button>
        </div>
    </div>

    <!-- Create Group/Page Modal -->
    <div class="modal-overlay" id="create-modal">
        <div class="modal-card">
            <div class="modal-header">
                <span id="create-title">إنشاء</span>
                <span style="cursor: pointer;" onclick="closeModal('create-modal')">✕</span>
            </div>
            <input type="text" id="create-name" class="auth-input" placeholder="الاسم">
            <input type="text" id="create-desc" class="auth-input" placeholder="الوصف (للمجموعات)">
            <button class="btn-main" style="width: 100%;" onclick="submitCreation()">إنشاء الآن</button>
        </div>
    </div>

    <!-- App Interface -->
    <div id="app-interface">
        <nav>
            <div style="font-size: 22px; font-weight: bold; color: var(--primary); cursor: pointer;" onclick="resetHome()">Blogane</div>
            <div style="display: flex; gap: 20px; font-size: 18px;">
                <i class="fas fa-home" style="cursor: pointer;" onclick="resetHome()"></i>
                <i class="fas fa-users" style="cursor: pointer;" onclick="openCreateModal('group')"></i>
                <i class="fas fa-flag" style="cursor: pointer;" onclick="openCreateModal('page')"></i>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="openProfileModal()">
                <img src="" id="nav-avatar" class="avatar">
                <span id="nav-name" style="font-weight: bold; font-size: 14px;"></span>
            </div>
        </nav>

        <div class="container">
            <!-- Right Sidebar: Menu & Groups -->
            <aside class="panel sidebar-right">
                <div class="menu-item" onclick="resetHome()"><i class="fas fa-globe"></i> العامة</div>
                <div class="menu-item" onclick="openProfileModal()"><i class="fas fa-user"></i> ملفي الشخصي</div>
                
                <h4 style="margin: 20px 0 10px 0; color: var(--primary);">المجموعات</h4>
                <div id="groups-list"></div>
                
                <h4 style="margin: 20px 0 10px 0; color: var(--accent);">الصفحات</h4>
                <div id="pages-list"></div>
            </aside>

            <!-- Main Feed -->
            <main class="panel" style="background: transparent; border: none; padding: 0;">
                
                <!-- Header for Groups/Pages/Profile -->
                <div class="context-header" id="context-header">
                    <h1 id="context-title">عنوان</h1>
                    <p id="context-desc" style="opacity: 0.8;">وصف</p>
                    <button class="btn-main btn-outline" id="context-action" style="margin: 10px auto 0;">انضمام</button>
                </div>

                <!-- Create Post -->
                <div class="create-post">
                    <div style="display: flex; gap: 10px;">
                        <img src="" id="post-avatar" class="avatar">
                        <textarea id="post-input" rows="2" placeholder="ماذا يدور في ذهنك؟"></textarea>
                    </div>
                    
                    <!-- Media Inputs (Hidden by default, toggleable could be better but keeping simple) -->
                    <div id="media-inputs" style="display: none; margin-top: 10px;">
                         <input type="text" id="media-url" class="auth-input" placeholder="رابط الصورة أو فيديو يوتيوب">
                         <select id="media-type" class="auth-input" style="width: auto; display: inline-block;">
                             <option value="image">صورة</option>
                             <option value="video">فيديو</option>
                         </select>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--glass-border);">
                        <div style="display: flex; gap: 15px; color: var(--text-gray);">
                            <span style="cursor: pointer;" onclick="toggleMediaInput()"><i class="fas fa-image" style="color: #10b981;"></i> ميديا</span>
                        </div>
                        <button class="btn-main" onclick="publishPost()">نشر</button>
                    </div>
                </div>

                <div id="feed-container"></div>
            </main>

            <!-- Left Sidebar: Friends -->
            <aside class="panel sidebar-left">
                <h4 style="margin-bottom: 15px;">طلبات الصداقة</h4>
                <div id="friend-requests"></div>
                
                <h4 style="margin: 20px 0 10px 0;">إضافة صديق</h4>
                <div style="display: flex; gap: 5px;">
                    <input type="email" id="friend-email" class="auth-input" placeholder="الإيميل" style="margin:0; padding: 8px;">
                    <button class="btn-main" onclick="sendRequest()" style="padding: 0 10px;"><i class="fas fa-plus"></i></button>
                </div>

                <h4 style="margin-top: 20px;">الأصدقاء المتصلين</h4>
                <div id="friends-list"></div>
            </aside>
        </div>
    </div>

    <script>
        const socket = io();
        
        // State
        let currentUser = null;
        let currentContext = 'general'; // 'general', 'group', 'page'
        let currentContextId = null;
        let isRegister = false;
        let createType = ''; // group or page

        // --- AUTH ---
        function toggleAuthMode() {
            isRegister = !isRegister;
            document.getElementById('reg-name').style.display = isRegister ? 'block' : 'none';
        }

        function login() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            if(isRegister) {
                const name = document.getElementById('reg-name').value;
                socket.emit('register', { name, email, password: pass });
            } else {
                socket.emit('login', { email, password: pass });
            }
        }

        socket.on('auth_success', (user) => {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-interface').style.display = 'flex';
            updateUserInfo();
        });
        
        function updateUserInfo() {
            document.getElementById('nav-name').innerText = currentUser.name;
            document.getElementById('nav-avatar').src = currentUser.avatar;
            document.getElementById('post-avatar').src = currentUser.avatar;
        }

        // --- PROFILE ---
        function openProfileModal() {
            document.getElementById('edit-profile-modal').style.display = 'flex';
            document.getElementById('edit-name').value = currentUser.name;
            document.getElementById('edit-bio').value = currentUser.bio || '';
            document.getElementById('edit-avatar').value = currentUser.avatar;
        }

        function saveProfile() {
            const updated = {
                email: currentUser.email,
                name: document.getElementById('edit-name').value,
                bio: document.getElementById('edit-bio').value,
                avatar: document.getElementById('edit-avatar').value
            };
            socket.emit('update_profile', updated);
            closeModal('edit-profile-modal');
        }
        
        socket.on('profile_updated', (user) => {
             // تحديث الواجهة إذا كنت أنا المعدل
             if(currentUser && currentUser.email === user.email) {
                 currentUser = user;
                 updateUserInfo();
             }
             // تحديث المنشورات في الـ DOM (اختياري معقد، سنكتفي بتحديث الذاكرة)
        });

        // --- NAVIGATION & CONTEXT ---
        function resetHome() {
            currentContext = 'general';
            currentContextId = null;
            document.getElementById('context-header').style.display = 'none';
            document.getElementById('feed-container').innerHTML = '';
            socket.emit('get_context_posts', { context: 'general', contextId: null });
        }

        function enterContext(type, id, name, desc) {
            currentContext = type;
            currentContextId = id;
            
            // Header UI
            const header = document.getElementById('context-header');
            header.style.display = 'block';
            document.getElementById('context-title').innerText = name;
            document.getElementById('context-desc').innerText = desc || (type === 'group' ? 'مجموعة عامة' : 'صفحة عامة');
            
            const actionBtn = document.getElementById('context-action');
            if(type === 'group') {
                actionBtn.innerText = 'انضمام للمجموعة';
                actionBtn.onclick = () => socket.emit('join_group', { groupId: id, email: currentUser.email });
            } else {
                actionBtn.innerText = 'متابعة الصفحة';
            }

            // Load Posts
            document.getElementById('feed-container').innerHTML = '';
            socket.emit('get_context_posts', { context: type, contextId: id });
        }

        // --- POSTS & INTERACTIONS ---
        function toggleMediaInput() {
            const div = document.getElementById('media-inputs');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        function publishPost() {
            const content = document.getElementById('post-input').value;
            const mediaUrl = document.getElementById('media-url').value;
            const mediaType = document.getElementById('media-type').value;
            
            if(!content && !mediaUrl) return;

            socket.emit('new_post', {
                author: currentUser.name,
                email: currentUser.email,
                avatar: currentUser.avatar,
                content,
                mediaType: mediaUrl ? mediaType : null,
                mediaUrl,
                context: currentContext,
                contextId: currentContextId
            });
            
            document.getElementById('post-input').value = '';
            document.getElementById('media-url').value = '';
            document.getElementById('media-inputs').style.display = 'none';
        }

        socket.on('receive_post', (post) => {
            // عرض المنشور فقط إذا كان يطابق السياق الحالي
            if(post.context === currentContext && post.contextId === currentContextId) {
                const feed = document.getElementById('feed-container');
                feed.insertAdjacentHTML('afterbegin', createPostHTML(post));
            }
        });

        socket.on('load_posts', (posts) => {
            const feed = document.getElementById('feed-container');
            feed.innerHTML = '';
            posts.forEach(p => feed.insertAdjacentHTML('beforeend', createPostHTML(p)));
        });

        function createPostHTML(post) {
            let mediaContent = '';
            if(post.mediaUrl) {
                if(post.mediaType === 'image') {
                    mediaContent = `<img src="${post.mediaUrl}" class="post-img">`;
                } else if(post.mediaType === 'video') {
                    // Simple Youtube Embed Check
                    if(post.mediaUrl.includes('youtube.com') || post.mediaUrl.includes('youtu.be')) {
                        const videoId = post.mediaUrl.split('v=')[1] || post.mediaUrl.split('/').pop();
                        mediaContent = `<iframe src="https://www.youtube.com/embed/${videoId}" style="width:100%; height:300px; border:none; margin-top:10px; border-radius:10px;"></iframe>`;
                    } else {
                        mediaContent = `<video src="${post.mediaUrl}" controls class="post-img"></video>`;
                    }
                }
            }

            // Render Comments
            let commentsHTML = '';
            post.comments.forEach(c => {
                commentsHTML += `
                <div class="comment">
                    <img src="${c.userAvatar}" style="width:25px; height:25px; border-radius:50%">
                    <div class="comment-bubble">
                        <div style="font-weight:bold; font-size:12px">${c.userName}</div>
                        <div>${c.text}</div>
                    </div>
                </div>`;
            });

            return `
            <div class="post" id="post-${post.id}">
                <div class="post-header">
                    <img src="${post.avatar}" class="avatar">
                    <div>
                        <div style="font-weight:bold">${post.author}</div>
                        <div style="font-size:12px; color:var(--text-gray)">${new Date(post.date).toLocaleTimeString()}</div>
                    </div>
                </div>
                <div style="font-size:15px; line-height:1.5; white-space: pre-wrap;">${post.content}</div>
                ${mediaContent}
                
                <div class="post-actions">
                    <div class="action-btn" onclick="likePost(${post.id})">
                        <i class="fas fa-heart" id="like-icon-${post.id}" style="${post.likes.includes(currentUser.email) ? 'color:#ef4444' : ''}"></i> 
                        <span id="likes-count-${post.id}">${post.likes.length}</span>
                    </div>
                    <div class="action-btn" onclick="document.getElementById('comments-${post.id}').style.display = 'block'">
                        <i class="fas fa-comment"></i> تعليق
                    </div>
                </div>

                <div class="comments-section" id="comments-${post.id}">
                    <div id="comments-list-${post.id}">${commentsHTML}</div>
                    <div style="display:flex; gap:10px; margin-top:10px">
                        <img src="${currentUser.avatar}" style="width:30px; height:30px; border-radius:50%">
                        <input type="text" class="auth-input" style="margin:0; padding:8px; font-size:12px" 
                            placeholder="اكتب تعليقاً..." onkeypress="submitComment(event, ${post.id})">
                    </div>
                </div>
            </div>`;
        }

        // Likes & Comments Logic
        function likePost(postId) {
            socket.emit('like_post', { postId, userEmail: currentUser.email });
        }

        socket.on('update_post_stats', ({ postId, likes }) => {
            const countEl = document.getElementById(`likes-count-${postId}`);
            const iconEl = document.getElementById(`like-icon-${postId}`);
            if(countEl) countEl.innerText = likes.length;
            if(iconEl) iconEl.style.color = likes.includes(currentUser.email) ? '#ef4444' : '';
        });

        function submitComment(e, postId) {
            if(e.key === 'Enter') {
                const text = e.target.value;
                if(!text) return;
                socket.emit('comment_post', { 
                    postId, text, 
                    userEmail: currentUser.email, 
                    userName: currentUser.name, 
                    userAvatar: currentUser.avatar 
                });
                e.target.value = '';
            }
        }

        socket.on('new_comment', ({ postId, comment }) => {
            const list = document.getElementById(`comments-list-${postId}`);
            if(list) {
                list.innerHTML += `
                <div class="comment">
                    <img src="${comment.userAvatar}" style="width:25px; height:25px; border-radius:50%">
                    <div class="comment-bubble">
                        <div style="font-weight:bold; font-size:12px">${comment.userName}</div>
                        <div>${comment.text}</div>
                    </div>
                </div>`;
            }
        });

        // --- GROUPS & PAGES CREATION ---
        function openCreateModal(type) {
            createType = type;
            document.getElementById('create-modal').style.display = 'flex';
            document.getElementById('create-title').innerText = type === 'group' ? 'إنشاء مجموعة' : 'إنشاء صفحة';
            document.getElementById('create-desc').style.display = type === 'group' ? 'block' : 'none';
        }

        function submitCreation() {
            const name = document.getElementById('create-name').value;
            const desc = document.getElementById('create-desc').value;
            if(!name) return;

            if(createType === 'group') {
                socket.emit('create_group', { name, desc, owner: currentUser.email });
            } else {
                socket.emit('create_page', { name, owner: currentUser.email });
            }
            closeModal('create-modal');
        }

        // --- SIDEBAR DATA ---
        socket.on('init_data', (data) => {
            updateSidebars(data.groups, data.pages);
        });
        socket.on('update_groups', (groups) => updateSidebars(groups, null));
        socket.on('update_pages', (pages) => updateSidebars(null, pages));

        function updateSidebars(groups, pages) {
            if(groups) {
                const gList = document.getElementById('groups-list');
                gList.innerHTML = '';
                groups.forEach(g => {
                    gList.innerHTML += `<div class="menu-item" onclick="enterContext('group', '${g.id}', '${g.name}', '${g.description}')"><i class="fas fa-users"></i> ${g.name}</div>`;
                });
            }
            if(pages) {
                const pList = document.getElementById('pages-list');
                pList.innerHTML = '';
                pages.forEach(p => {
                    pList.innerHTML += `<div class="menu-item" onclick="enterContext('page', '${p.id}', '${p.name}', '')"><i class="fas fa-flag"></i> ${p.name}</div>`;
                });
            }
        }

        // --- FRIENDS ---
        function sendRequest() {
            const email = document.getElementById('friend-email').value;
            socket.emit('send_friend_request', { fromEmail: currentUser.email, toEmail: email });
            document.getElementById('friend-email').value = '';
        }

        socket.on('update_requests', (reqs) => {
            const list = document.getElementById('friend-requests');
            list.innerHTML = '';
            reqs.forEach(r => {
                list.innerHTML += `
                <div class="friend-req-card">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px">
                        <img src="${r.avatar}" style="width:30px; height:30px; border-radius:50%">
                        <span style="font-size:13px">${r.name}</span>
                    </div>
                    <div style="display:flex; gap:5px">
                        <button class="btn-main" style="font-size:11px; padding:5px; flex:1" onclick="resp('${r.email}', true)">قبول</button>
                        <button class="btn-main btn-outline" style="font-size:11px; padding:5px; flex:1" onclick="resp('${r.email}', false)">رفض</button>
                    </div>
                </div>`;
            });
        });

        function resp(email, accept) {
            socket.emit('respond_friend_request', { userEmail: currentUser.email, requesterEmail: email, accept });
        }

        socket.on('update_friends', (friends) => {
            const list = document.getElementById('friends-list');
            list.innerHTML = '';
            friends.forEach(f => {
                list.innerHTML += `
                <div class="menu-item" style="justify-content:space-between">
                    <div style="display:flex; gap:10px; align-items:center">
                        <img src="${f.avatar}" style="width:30px; height:30px; border-radius:50%">
                        <span>${f.name}</span>
                    </div>
                    ${f.isOnline ? '<div style="width:8px; height:8px; background:#10b981; border-radius:50%"></div>' : ''}
                </div>`;
            });
        });

        // Helpers
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    </script>
</body>
                             </html>
