<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blogane Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --primary: #8b5cf6; --text: #fff; --gray: #94a3b8; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        html { scroll-behavior: smooth; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* UI Components */
        .btn { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .input-box { width: 100%; background: #334155; border: none; padding: 12px; border-radius: 8px; color: white; outline: none; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        
        /* Navigation */
        .bottom-nav { 
            height: 65px; background: var(--panel); display: flex; justify-content: space-around; align-items: center; 
            position: fixed; bottom: 0; width: 100%; z-index: 500; border-top: 1px solid #333; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }
        .nav-item { color: var(--gray); font-size: 24px; text-align: center; cursor: pointer; position: relative; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .nav-item span { font-size: 10px; display: block; }
        .badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 10px; padding: 2px 5px; border-radius: 50%; display: none; }

        /* Views */
        .view { display: none; height: 100%; overflow-y: auto; padding-bottom: 90px; opacity: 0; transition: opacity 0.3s; }
        .view.active { display: block; opacity: 1; }

        /* Header */
        .header { padding: 15px; background: rgba(30,41,59,0.95); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }

        /* Posts */
        .post { background: var(--panel); margin-bottom: 10px; padding: 15px; border-radius: 0; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
        .post-img { width: 100%; border-radius: 10px; margin-top: 10px; max-height: 400px; object-fit: cover; }
        .actions { display: flex; gap: 20px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; color: var(--gray); }
        .act-btn { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .liked { color: #ef4444; }

        /* Modal */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: var(--panel); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; max-height: 90%; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* Reels Style */
        .reel-item { height: calc(100vh - 65px); background: black; display: flex; flex-direction: column; justify-content: center; position: relative; border-bottom: 1px solid #333; snap-align: start; }
        .reel-video { width: 100%; max-height: 100%; object-fit: contain; }
        #reels-container { height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; }
        
        /* Comment Box */
        .comment-popup { background: #1e293b; padding: 10px; border-radius: 10px; margin-bottom: 5px; animation: slideUp 0.3s; }
        @keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }

    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <h3 style="color: white;" id="loading-text">جاري المعالجة...</h3>
    </div>

    <!-- Auth -->
    <div class="modal-overlay" id="auth-modal" style="display: flex;">
        <div class="modal" style="text-align: center;">
            <h2 style="color: var(--primary);">Blogane Pro</h2>
            <div id="reg-fields" style="display: none;">
                <input type="text" id="reg-name" class="input-box" placeholder="الاسم">
            </div>
            <input type="email" id="email" class="input-box" placeholder="البريد الإلكتروني">
            <input type="password" id="pass" class="input-box" placeholder="كلمة المرور">
            <button class="btn" style="width: 100%; margin-top:10px" onclick="auth()">دخول</button>
            <p style="margin-top: 15px; color: var(--primary); cursor: pointer;" onclick="toggleAuth()">ليس لديك حساب؟</p>
        </div>
    </div>

    <!-- Comment Modal -->
    <div class="modal-overlay" id="comment-modal">
        <div class="modal">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <h3>التعليقات</h3>
                <span onclick="closeModal('comment-modal')" style="cursor: pointer; font-size:20px">✕</span>
            </div>
            <div id="comments-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 10px;"></div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="comment-input" class="input-box" style="margin:0" placeholder="اكتب تعليقاً...">
                <button class="btn" onclick="submitComment()">إرسال</button>
            </div>
        </div>
    </div>

    <!-- Reels Upload Modal -->
    <div class="modal-overlay" id="reel-modal">
        <div class="modal">
            <h3>نشر فيديو (Reel)</h3>
            <p style="color:#aaa; font-size:12px; margin-bottom:10px">اختر فيديو من هاتفك (حتى 50 ميجا)</p>
            <input type="file" id="reel-file" class="input-box" accept="video/*">
            <input type="text" id="reel-desc" class="input-box" placeholder="وصف الفيديو...">
            <button class="btn" style="width:100%" onclick="uploadReel()">نشر الفيديو</button>
            <button class="btn" style="width:100%; background:transparent; margin-top:5px" onclick="closeModal('reel-modal')">إلغاء</button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="edit-profile-modal">
        <div class="modal">
            <h3>تعديل الملف الشخصي</h3>
            <label>صورة الملف الشخصي</label>
            <input type="file" id="profile-upload" class="input-box" accept="image/*">
            <input type="text" id="edit-name" class="input-box" placeholder="الاسم">
            <textarea id="edit-bio" class="input-box" placeholder="نبذة عنك"></textarea>
            <button class="btn" id="save-profile-btn" style="width: 100%;" onclick="saveProfile()">حفظ</button>
            <button class="btn" style="width: 100%; background: transparent; margin-top: 5px;" onclick="closeModal('edit-profile-modal')">إلغاء</button>
        </div>
    </div>

    <!-- 1. HOME VIEW -->
    <div id="view-home" class="view active">
        <div class="header" id="main-header">
            <h3>الرئيسية</h3>
            <img src="" id="header-avatar" class="avatar" onclick="navTo('profile')">
        </div>
        
        <div id="context-banner" style="background:linear-gradient(to right, #6366f1, #a855f7); padding:15px; text-align:center; display:none">
            <h2 id="ctx-name" style="color: white;"></h2>
            <button class="btn" style="background: rgba(0,0,0,0.3); margin-top: 10px;" onclick="leaveContext()">رجوع للعامة</button>
        </div>

        <div style="padding: 15px; background: var(--panel); margin-bottom: 10px;">
            <div style="display: flex; gap: 10px;">
                <img src="" id="my-avatar" class="avatar">
                <input type="text" id="post-txt" class="input-box" style="border-radius: 20px; margin:0" placeholder="بماذا تفكر؟">
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                <label class="btn" style="background: transparent; border: 1px solid #555;">
                    <i class="fas fa-image" style="color: #10b981;"></i> صورة
                    <input type="file" id="post-img" hidden accept="image/*">
                </label>
                <button class="btn" onclick="publishPost()">نشر</button>
            </div>
            <div id="post-preview"></div>
        </div>

        <div id="feed"></div>
    </div>

    <!-- 2. EXPLORE VIEW -->
    <div id="view-explore" class="view">
        <div class="header"><h3>استكشف</h3></div>
        <div style="padding: 15px;">
            <div style="background: #334155; padding: 10px; border-radius: 10px; margin-bottom: 20px;">
                <h4>طلبات الصداقة <span id="req-count" class="badge" style="position:static; display:inline-block;">0</span></h4>
                <div id="req-list" style="margin-top: 10px;"></div>
                <div style="display:flex; gap:5px; margin-top:10px">
                    <input type="email" id="friend-email" class="input-box" style="margin:0; font-size:12px" placeholder="إيميل صديق">
                    <button class="btn" onclick="addFriend()">إضافة</button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn" onclick="createContext('group')">+ مجموعة</button>
                <button class="btn" style="background: #ec4899;" onclick="createContext('page')">+ صفحة</button>
            </div>
            
            <h4 style="color: var(--gray);">المجموعات</h4>
            <div id="groups-list"></div>
            <h4 style="color: var(--gray); margin-top: 15px;">الصفحات</h4>
            <div id="pages-list"></div>
        </div>
    </div>

    <!-- 3. REELS VIEW -->
    <div id="view-reels" class="view" style="background: black; padding-bottom: 65px;">
        <div style="position: fixed; top: 20px; left: 20px; z-index: 200;">
             <button class="btn" style="background: rgba(255,255,255,0.3); backdrop-filter:blur(5px)" onclick="document.getElementById('reel-modal').style.display='flex'">+ نشر فيديو</button>
        </div>
        <div id="reels-container"></div>
    </div>

    <!-- 4. CHAT VIEW -->
    <div id="view-chat" class="view">
        <div class="header"><h3>الدردشة العامة</h3></div>
        <div id="global-chat" style="padding: 10px; padding-bottom: 80px;"></div>
        <div style="position: fixed; bottom: 65px; width: 100%; background: var(--panel); padding: 10px; display: flex; gap: 10px;">
            <label style="display:flex;align-items:center; margin-left:5px"><i class="fas fa-image" style="font-size:20px; color:#aaa"></i><input type="file" id="chat-img-upload" hidden></label>
            <input type="text" id="chat-input" class="input-box" style="margin:0" placeholder="رسالة...">
            <button class="btn" onclick="sendGlobal()">➤</button>
        </div>
    </div>

    <!-- 5. PROFILE VIEW -->
    <div id="view-profile" class="view">
        <div class="profile-header">
            <img src="" id="profile-avatar" class="p-avatar">
            <h2 id="profile-name" style="margin-top: 10px;"></h2>
            <p id="profile-bio" style="color: #cbd5e1; font-size: 14px;"></p>
            <button class="btn" style="background: rgba(255,255,255,0.2); margin-top: 10px;" onclick="openEditProfile()">تعديل الملف</button>
        </div>
        <div style="padding: 15px;">
            <h3>منشوراتي</h3>
            <div id="profile-posts"></div>
        </div>
    </div>

    <!-- Navbar -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i><span>الرئيسية</span></div>
        <div class="nav-item" onclick="navTo('explore', this)">
            <i class="fas fa-compass"></i><span>استكشف</span>
            <div class="badge" id="nav-req-badge">0</div>
        </div>
        <div class="nav-item" onclick="navTo('reels', this)"><i class="fas fa-play-circle"></i><span>ريلز</span></div>
        <div class="nav-item" onclick="navTo('chat', this)"><i class="fas fa-comments"></i><span>الدردشة</span></div>
        <div class="nav-item" onclick="navTo('profile', this)"><i class="fas fa-user"></i><span>ملفي</span></div>
    </div>

    <script>
        const socket = io();
        let currentUser = null;
        let currentContext = 'general';
        let currentContextId = null;
        let currentPostIdForComment = null;
        let isReg = false;

        function showLoading(text) {
            document.getElementById('loading-text').innerText = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- Navigation ---
        function navTo(viewId, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            else if(viewId === 'profile') document.querySelector('.nav-item:last-child').classList.add('active');
            
            if(viewId === 'profile') socket.emit('get_user_posts', currentUser.email);
        }

        // --- Auth ---
        function toggleAuth() {
            isReg = !isReg;
            document.getElementById('reg-fields').style.display = isReg ? 'block' : 'none';
        }
        function auth() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            if(isReg) {
                const name = document.getElementById('reg-name').value;
                socket.emit('register', { name, email, password: pass });
            } else {
                socket.emit('login', { email, password: pass });
            }
        }
        socket.on('auth_success', (user) => {
            currentUser = user;
            document.getElementById('auth-modal').style.display = 'none';
            updateUserUI();
        });
        function updateUserUI() {
            document.getElementById('my-avatar').src = currentUser.avatar;
            document.getElementById('header-avatar').src = currentUser.avatar;
            document.getElementById('profile-avatar').src = currentUser.avatar;
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-bio').innerText = currentUser.bio || '';
        }

        // --- Context (Groups/Pages) ---
        function enterContext(type, id, name) {
            currentContext = type;
            currentContextId = id;
            navTo('home');
            document.getElementById('main-header').style.display = 'none';
            document.getElementById('context-banner').style.display = 'block';
            document.getElementById('ctx-name').innerText = name;
            document.getElementById('feed').innerHTML = '';
            socket.emit('get_context_posts', { context: type, contextId: id });
        }
        function leaveContext() {
            currentContext = 'general';
            currentContextId = null;
            document.getElementById('main-header').style.display = 'flex';
            document.getElementById('context-banner').style.display = 'none';
            document.getElementById('feed').innerHTML = '';
            socket.emit('get_context_posts', { context: 'general', contextId: null });
        }

        // --- Posts ---
        let postImgData = null;
        document.getElementById('post-img').addEventListener('change', function() {
            const file = this.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    postImgData = e.target.result;
                    document.getElementById('post-preview').innerHTML = `<img src="${postImgData}" style="height:100px; border-radius:10px; margin-top:5px">`;
                };
                reader.readAsDataURL(file);
            }
        });

        function publishPost() {
            const txt = document.getElementById('post-txt').value;
            if(!txt && !postImgData) return;
            
            showLoading('جاري نشر المنشور...');
            
            socket.emit('new_post', {
                content: txt, media: postImgData, 
                author: currentUser.name, email: currentUser.email, avatar: currentUser.avatar,
                context: currentContext, contextId: currentContextId
            });
            document.getElementById('post-txt').value = '';
            document.getElementById('post-preview').innerHTML = '';
            postImgData = null;
        }
        
        // إخفاء التحميل عند انتهاء الرفع
        socket.on('upload_complete', () => {
            hideLoading();
            if(document.getElementById('reel-modal').style.display === 'block') {
                closeModal('reel-modal');
                navTo('reels');
            }
        });

        socket.on('receive_post', (post) => {
            // إخفاء التحميل إذا كان هو الناشر
            if(post.email === currentUser.email) hideLoading();
            
            if(post.context === currentContext && post.contextId === currentContextId) {
                renderPost(post, 'feed');
            }
        });
        
        socket.on('load_posts', (posts) => {
            document.getElementById('feed').innerHTML = '';
            posts.reverse().forEach(p => renderPost(p, 'feed'));
        });

        function renderPost(post, containerId) {
            const container = document.getElementById(containerId);
            const isLiked = post.likes.includes(currentUser.email);
            const imgHtml = post.media ? `<img src="${post.media}" class="post-img">` : '';
            
            const html = `
            <div class="post" id="post-${post.id}">
                <div style="display:flex; gap:10px; align-items:center">
                    <img src="${post.avatar}" class="avatar">
                    <div><b>${post.author}</b><br><small style="color:#aaa">${new Date(post.date).toLocaleTimeString()}</small></div>
                </div>
                <p style="margin-top:10px">${post.content || ''}</p>
                ${imgHtml}
                <div class="actions">
                    <div class="act-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike(${post.id}, 'post')">
                        <i class="fas fa-heart"></i> <span id="likes-count-${post.id}">${post.likes.length}</span>
                    </div>
                    <div class="act-btn" onclick="openComments(${post.id})">
                        <i class="fas fa-comment"></i> <span id="comments-count-${post.id}">${post.comments.length}</span>
                    </div>
                </div>
            </div>`;
            container.insertAdjacentHTML('afterbegin', html);
        }

        // --- REELS (Native Upload) ---
        function uploadReel() {
            const file = document.getElementById('reel-file').files[0];
            const desc = document.getElementById('reel-desc').value;
            
            if(file) {
                showLoading('جاري رفع الفيديو، قد يستغرق وقتاً...');
                const reader = new FileReader();
                reader.onload = (e) => {
                    const videoBase64 = e.target.result;
                    socket.emit('new_reel', {
                        videoBase64: videoBase64,
                        desc: desc,
                        author: currentUser.name,
                        avatar: currentUser.avatar
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        socket.on('receive_reel', (reel) => {
            const container = document.getElementById('reels-container');
            const html = `
            <div class="reel-item">
                <video src="${reel.videoBase64}" controls class="reel-video"></video>
                <div style="position:absolute; bottom:20px; right:20px; z-index:10; text-align:right; text-shadow:1px 1px 3px black">
                    <div style="display:flex; align-items:center; gap:10px; justify-content:flex-end">
                        <b>${reel.author}</b> <img src="${reel.avatar}" class="avatar" style="border:2px solid white">
                    </div>
                    <p>${reel.desc}</p>
                    <div class="act-btn" onclick="toggleLike(${reel.id}, 'reel')" style="color:white; margin-top:10px">
                         <i class="fas fa-heart"></i> <span id="likes-count-${reel.id}">${reel.likes.length}</span>
                    </div>
                </div>
            </div>`;
            container.insertAdjacentHTML('afterbegin', html);
        });

        // --- Comments ---
        function openComments(postId) {
            currentPostIdForComment = postId;
            document.getElementById('comment-modal').style.display = 'flex';
            document.getElementById('comments-list').innerHTML = '<p style="text-align:center; color:#aaa">جاري تحميل التعليقات...</p>';
            // في هذا النظام البسيط، لا نقوم بجلب التعليقات من السيرفر عند الفتح (لأننا لا نخزنها منفصلة)،
            // بل نعتمد على التحديث الفوري. لتحسين ذلك، يجب أن يرسل السيرفر التعليقات عند الطلب.
            // هنا سأقوم بمسح القائمة لانتظار التعليقات الجديدة.
             document.getElementById('comments-list').innerHTML = '';
        }
        function submitComment() {
            const txt = document.getElementById('comment-input').value;
            if(txt) {
                socket.emit('add_comment', { postId: currentPostIdForComment, text: txt, userEmail: currentUser.email, userName: currentUser.name, userAvatar: currentUser.avatar });
                document.getElementById('comment-input').value = '';
            }
        }
        socket.on('update_comments', ({ postId, comments }) => {
            // تحديث العداد
            const countEl = document.getElementById(`comments-count-${postId}`);
            if(countEl) countEl.innerText = comments.length;

            // تحديث القائمة إذا كانت مفتوحة
            if(currentPostIdForComment === postId) {
                const list = document.getElementById('comments-list');
                list.innerHTML = '';
                comments.forEach(c => {
                    list.innerHTML += `
                    <div class="comment-popup">
                        <div style="display:flex; gap:10px;">
                            <img src="${c.userAvatar}" class="avatar" style="width:30px; height:30px">
                            <div>
                                <b style="font-size:12px">${c.userName}</b>
                                <div style="font-size:14px">${c.text}</div>
                            </div>
                        </div>
                    </div>`;
                });
            }
        });
        function toggleLike(id, type) { socket.emit('toggle_like', { id, type, userEmail: currentUser.email }); }
        socket.on('update_likes', ({ id, likes }) => {
            const countEl = document.getElementById(`likes-count-${id}`);
            if(countEl) countEl.innerText = likes.length;
        });

        // --- Profile Edit ---
        function openEditProfile() {
            document.getElementById('edit-profile-modal').style.display = 'flex';
            document.getElementById('edit-name').value = currentUser.name;
            document.getElementById('edit-bio').value = currentUser.bio || '';
        }
        function saveProfile() {
            showLoading('جاري حفظ التغييرات...');
            const name = document.getElementById('edit-name').value;
            const bio = document.getElementById('edit-bio').value;
            const file = document.getElementById('profile-upload').files[0];
            const data = { email: currentUser.email, name, bio };

            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    data.avatar = e.target.result;
                    socket.emit('update_profile', data);
                };
                reader.readAsDataURL(file);
            } else {
                socket.emit('update_profile', data);
            }
        }
        socket.on('profile_updated_success', (user) => {
            hideLoading();
            currentUser = user;
            updateUserUI();
            closeModal('edit-profile-modal');
        });

        // --- Chat ---
        let chatImg = null;
        document.getElementById('chat-img-upload').addEventListener('change', function() {
            const file = this.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => { chatImg = e.target.result; alert('تم اختيار الصورة'); };
                reader.readAsDataURL(file);
            }
        });
        function sendGlobal() {
            const txt = document.getElementById('chat-input').value;
            if(!txt && !chatImg) return;
            socket.emit('send_global_msg', { text: txt, image: chatImg, author: currentUser.name, email: currentUser.email, avatar: currentUser.avatar });
            document.getElementById('chat-input').value = ''; chatImg = null;
        }
        socket.on('receive_global_msg', (msg) => {
            const box = document.getElementById('global-chat');
            const isMe = msg.email === currentUser.email;
            const imgHtml = msg.image ? `<br><img src="${msg.image}" style="max-width:150px; border-radius:10px">` : '';
            box.innerHTML += `<div style="margin-bottom:5px; text-align:${isMe?'left':'right'}"><div style="display:inline-block; padding:8px; border-radius:10px; background:${isMe?'var(--primary)':'#334155'}"><b>${isMe?'':msg.author+':'}</b> ${msg.text||''} ${imgHtml}</div></div>`;
        });

        // --- Init Data ---
        socket.on('init_data', (data) => {
            // Load Explore Lists
            const gList = document.getElementById('groups-list');
            gList.innerHTML = data.groups.map(g => `<div class="list-item" onclick="enterContext('group','${g.id}','${g.name}')"><b>${g.name}</b> <small>${g.members.length} عضو</small></div>`).join('');
            
            const pList = document.getElementById('pages-list');
            pList.innerHTML = data.pages.map(p => `<div class="list-item" onclick="enterContext('page','${p.id}','${p.name}')"><b>${p.name}</b></div>`).join('');

            // Load Reels
            const rList = document.getElementById('reels-container');
            rList.innerHTML = '';
            data.reels.forEach(r => {
                rList.innerHTML += `
                <div class="reel-item">
                    <video src="${r.videoBase64}" controls class="reel-video"></video>
                    <div style="position:absolute; bottom:20px; right:20px; text-align:right">
                        <b>${r.author}</b><p>${r.desc}</p>
                    </div>
                </div>`;
            });
            
            // Load Requests
            updateReqs(data.friendRequests || []);
        });
        
        socket.on('update_requests', (r) => updateReqs(r));
        function updateReqs(reqs) {
            document.getElementById('req-count').innerText = reqs.length;
            document.getElementById('nav-req-badge').style.display = reqs.length ? 'block' : 'none';
            document.getElementById('req-list').innerHTML = reqs.map(r => `<div class="list-item"><img src="${r.avatar}" class="avatar"><span>${r.name}</span><button class="btn" onclick="socket.emit('respond_friend_request',{userEmail:currentUser.email, requesterEmail:'${r.email}', accept:true})">قبول</button></div>`).join('');
        }
        function addFriend() { socket.emit('send_friend_request', { fromEmail: currentUser.email, toEmail: document.getElementById('friend-email').value }); document.getElementById('friend-email').value=''; }
        function createContext(type) { const n = prompt('الاسم:'); if(n) type==='group'?socket.emit('create_group',{name:n,desc:'',owner:currentUser.email}):socket.emit('create_page',{name:n,owner:currentUser.email}); }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
    </html>
