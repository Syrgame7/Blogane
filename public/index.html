<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blogane Social</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0f172a;
            --glass: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #6366f1;
            --accent: #ec4899;
            --text: #f8fafc;
            --text-gray: #94a3b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        
        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 4px; }

        /* --- Auth Screen --- */
        #auth-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(20px); z-index: 2000;
        }
        .auth-card {
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 40px; border-radius: 24px; width: 400px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .auth-input {
            width: 100%; padding: 15px; margin: 10px 0;
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            border-radius: 12px; color: white; outline: none;
        }
        .btn-main {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none; padding: 15px; width: 100%; border-radius: 12px;
            color: white; font-weight: bold; font-size: 16px; cursor: pointer;
            transition: 0.3s;
        }
        .btn-main:hover { transform: scale(1.02); opacity: 0.9; }

        /* --- App Layout --- */
        #app-interface { display: none; height: 100vh; flex-direction: column; }

        /* Top Nav */
        nav {
            height: 70px; background: var(--glass); border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
            backdrop-filter: blur(10px);
        }
        .logo { font-size: 24px; font-weight: 800; background: linear-gradient(to right, #818cf8, #e879f9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-icons { display: flex; gap: 20px; font-size: 20px; }
        .nav-item { cursor: pointer; position: relative; padding: 10px; border-radius: 10px; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: var(--primary); }
        .badge { position: absolute; top: 0; right: 0; background: var(--accent); width: 10px; height: 10px; border-radius: 50%; display: none; }

        /* Main Grid */
        .container {
            display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px;
            padding: 20px; height: calc(100vh - 70px); max-width: 1600px; margin: 0 auto; width: 100%;
        }

        /* Cards & Panels */
        .panel {
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 20px; overflow-y: auto; height: 100%;
            backdrop-filter: blur(10px);
        }

        /* Left Sidebar (Menu) */
        .menu-item {
            display: flex; align-items: center; gap: 15px; padding: 15px;
            border-radius: 12px; cursor: pointer; color: var(--text-gray); transition: 0.2s; margin-bottom: 5px;
        }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .menu-item i { width: 25px; }
        .section-title { font-size: 12px; color: var(--text-gray); margin: 20px 0 10px 0; letter-spacing: 1px; }

        /* Create Post */
        .create-post { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .create-post textarea {
            width: 100%; background: transparent; border: none; color: white; resize: none; font-size: 16px; outline: none;
        }
        .post-tools { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--glass-border); }

        /* Posts */
        .post { background: rgba(0,0,0,0.2); border-radius: 15px; padding: 20px; margin-bottom: 15px; animation: fadeIn 0.5s; }
        .post-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .user-info { display: flex; gap: 10px; align-items: center; cursor: pointer; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        
        /* Right Sidebar (Friends) */
        .friend-card { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .friend-card:hover { background: rgba(255,255,255,0.05); }
        .status { width: 10px; height: 10px; background: #10b981; border-radius: 50%; border: 2px solid var(--bg-dark); margin-right: auto; }

        /* Profile Section */
        .profile-header {
            background: linear-gradient(to bottom, var(--primary), var(--bg-dark));
            padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 20px;
        }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--bg-dark); margin-bottom: 10px; }

        /* Chat Window */
        .chat-window {
            position: fixed; bottom: 20px; left: 20px; width: 320px; height: 450px;
            background: #1e293b; border: 1px solid var(--glass-border); border-radius: 15px;
            display: none; flex-direction: column; z-index: 100; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .chat-head { padding: 15px; background: var(--primary); border-radius: 15px 15px 0 0; color: white; display: flex; justify-content: space-between; cursor: pointer; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 15px; max-width: 75%; font-size: 14px; }
        .msg-me { background: var(--primary); align-self: flex-start; }
        .msg-other { background: rgba(255,255,255,0.1); align-self: flex-end; }

        /* Utility Classes */
        .hidden { display: none; }
        .active-tab { color: var(--primary); border-bottom: 2px solid var(--primary); }
        
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .sidebar-left, .sidebar-right { display: none; } }
    </style>
</head>
<body>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-card">
            <h1 class="logo" style="font-size: 40px; margin-bottom: 20px;">Blogane</h1>
            <input type="text" id="reg-name" class="auth-input hidden" placeholder="الاسم الكامل">
            <input type="email" id="auth-email" class="auth-input" placeholder="البريد الإلكتروني">
            <input type="password" id="auth-pass" class="auth-input" placeholder="كلمة المرور">
            <button class="btn-main" id="login-btn" onclick="login()">تسجيل الدخول</button>
            <p style="margin-top: 15px; font-size: 14px; color: var(--text-gray); cursor: pointer;" onclick="toggleAuth()">إنشاء حساب جديد؟</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-interface">
        <nav>
            <div class="logo">Blogane</div>
            <div class="nav-icons">
                <div class="nav-item active" onclick="switchView('home')"><i class="fas fa-home"></i></div>
                <div class="nav-item" onclick="switchView('groups')"><i class="fas fa-users"></i></div>
                <div class="nav-item" onclick="switchView('pages')"><i class="fas fa-flag"></i></div>
                <div class="nav-item" onclick="requestProfile(currentUser.email)"><i class="fas fa-user-circle"></i></div>
                <div class="nav-item" onclick="location.reload()"><i class="fas fa-sign-out-alt" style="color: #ef4444;"></i></div>
            </div>
        </nav>

        <div class="container">
            <!-- Right Sidebar (Profile & Menu) -->
            <aside class="panel sidebar-right">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="" id="my-avatar" class="avatar" style="width: 80px; height: 80px;">
                    <h3 id="my-name" style="margin-top: 10px;"></h3>
                    <p style="color: var(--text-gray); font-size: 14px;">@مستخدم</p>
                </div>
                
                <div class="section-title">القائمة</div>
                <div class="menu-item" onclick="switchView('home')"><i class="fas fa-stream"></i> آخر الأخبار</div>
                <div class="menu-item" onclick="switchView('groups')"><i class="fas fa-users-cog"></i> مجموعاتي</div>
                <div class="menu-item" onclick="switchView('pages')"><i class="fas fa-thumbs-up"></i> الصفحات</div>
                
                <div class="section-title">طلبات الصداقة</div>
                <div id="requests-list">
                    <p style="font-size: 12px; color: var(--text-gray);">لا توجد طلبات جديدة</p>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="panel" id="main-content" style="background: transparent; border: none; padding: 0;">
                
                <!-- HOME VIEW -->
                <div id="view-home">
                    <div class="create-post">
                        <textarea id="post-text" rows="3" placeholder="بماذا تفكر اليوم؟"></textarea>
                        <div class="post-tools">
                            <div style="color: var(--primary);"><i class="fas fa-image"></i> صورة</div>
                            <button class="btn-main" style="width: auto; padding: 8px 25px;" onclick="publishPost('general')">نشر</button>
                        </div>
                    </div>
                    <div id="feed-general"></div>
                </div>

                <!-- PROFILE VIEW -->
                <div id="view-profile" class="hidden">
                    <div class="profile-header">
                        <img src="" id="p-avatar" class="profile-avatar">
                        <h2 id="p-name"></h2>
                        <button class="btn-main" style="width: auto; margin-top: 10px; background: rgba(255,255,255,0.2);">تعديل الملف</button>
                    </div>
                    <h3 style="margin-bottom: 15px;">منشورات المستخدم</h3>
                    <div id="feed-profile"></div>
                </div>

                <!-- GROUPS VIEW -->
                <div id="view-groups" class="hidden">
                    <h2>المجموعات النشطة</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="new-group-name" class="auth-input" placeholder="اسم المجموعة" style="margin: 0;">
                        <button class="btn-main" style="width: auto;" onclick="createGroup()">إنشاء</button>
                    </div>
                    <div id="groups-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
                    <hr style="border-color: var(--glass-border); margin: 20px 0;">
                    <h3>محتوى المجموعة</h3>
                    <div id="group-feed"></div>
                </div>

                <!-- PAGES VIEW -->
                <div id="view-pages" class="hidden">
                    <h2>الصفحات المقترحة</h2>
                    <div id="pages-list"></div>
                </div>

            </main>

            <!-- Left Sidebar (Friends & Chat) -->
            <aside class="panel sidebar-left">
                <div class="section-title">إضافة أصدقاء</div>
                <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                    <input type="email" id="friend-email" class="auth-input" placeholder="إيميل الصديق" style="margin: 0; padding: 8px;">
                    <button class="btn-main" style="width: 40px; padding: 0;" onclick="addFriend()"><i class="fas fa-plus"></i></button>
                </div>

                <div class="section-title">المتصلين الآن</div>
                <div id="friends-list"></div>
            </aside>
        </div>
    </div>

    <!-- Chat Box -->
    <div class="chat-window" id="chat-box">
        <div class="chat-head" onclick="toggleChat()">
            <span id="chat-name">اسم المستخدم</span>
            <i class="fas fa-times"></i>
        </div>
        <div class="chat-body" id="chat-msgs"></div>
        <div style="padding: 10px; border-top: 1px solid var(--glass-border);">
            <input type="text" id="msg-input" class="auth-input" placeholder="اكتب رسالة..." style="margin: 0;" onkeypress="handleMsg(event)">
        </div>
    </div>

    <script>
        const socket = io();
        let currentUser = null;
        let currentChat = null;
        let isRegister = false;

        // --- AUTH SYSTEM ---
        function toggleAuth() {
            isRegister = !isRegister;
            document.getElementById('reg-name').classList.toggle('hidden');
            document.getElementById('login-btn').innerText = isRegister ? 'إنشاء حساب' : 'تسجيل الدخول';
        }

        function login() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            if(isRegister) {
                const name = document.getElementById('reg-name').value;
                socket.emit('register', { name, email, password: pass });
            } else {
                socket.emit('login', { email, password: pass });
            }
        }

        socket.on('auth_success', (user) => {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-interface').style.display = 'flex';
            document.getElementById('my-name').innerText = user.name;
            document.getElementById('my-avatar').src = user.avatar;
        });

        // --- VIEWS NAVIGATION ---
        function switchView(viewName) {
            // Hide all views
            document.querySelectorAll('#main-content > div').forEach(div => div.classList.add('hidden'));
            // Show selected
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
        }

        // --- PROFILE SYSTEM ---
        function requestProfile(email) {
            socket.emit('get_profile', email);
            switchView('profile');
        }

        socket.on('open_profile', (data) => {
            document.getElementById('p-name').innerText = data.user.name;
            document.getElementById('p-avatar').src = data.user.avatar;
            const feed = document.getElementById('feed-profile');
            feed.innerHTML = '';
            data.posts.forEach(post => feed.innerHTML += createPostHTML(post));
        });

        // --- POSTS SYSTEM ---
        function publishPost(type, targetId = null) {
            const content = document.getElementById('post-text').value;
            if(!content) return;
            
            socket.emit('new_post', {
                author: currentUser.name,
                email: currentUser.email,
                avatar: currentUser.avatar,
                content,
                type,
                targetId
            });
            document.getElementById('post-text').value = '';
        }

        socket.on('receive_post', (post) => {
            const html = createPostHTML(post);
            // Logic to decide where to put the post
            if(post.type === 'general') {
                const feed = document.getElementById('feed-general');
                feed.innerHTML = html + feed.innerHTML;
            } else if (post.type === 'group') {
                // If we are in group view, add it there
                 const feed = document.getElementById('group-feed');
                 feed.innerHTML = html + feed.innerHTML;
            }
        });
        
        socket.on('load_posts', (posts) => {
            const feed = document.getElementById('feed-general');
            feed.innerHTML = '';
            posts.forEach(p => feed.innerHTML += createPostHTML(p));
        });

        function createPostHTML(post) {
            return `
            <div class="post">
                <div class="post-header">
                    <div class="user-info" onclick="requestProfile('${post.email}')">
                        <img src="${post.avatar}" class="avatar">
                        <div>
                            <div style="font-weight:bold">${post.author}</div>
                            <div style="font-size:12px; color:var(--text-gray)">${new Date(post.date).toLocaleTimeString()}</div>
                        </div>
                    </div>
                </div>
                <div style="line-height:1.6">${post.content}</div>
                <div style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); display:flex; gap:20px; color:var(--text-gray)">
                    <span><i class="far fa-heart"></i> إعجاب</span>
                    <span><i class="far fa-comment"></i> تعليق</span>
                </div>
            </div>`;
        }

        // --- GROUPS & PAGES ---
        function createGroup() {
            const name = document.getElementById('new-group-name').value;
            if(name) socket.emit('create_group', name);
        }

        socket.on('init_data', (data) => {
            renderGroups(data.groups);
            renderPages(data.pages);
        });
        
        socket.on('update_groups', (groups) => renderGroups(groups));
        socket.on('update_pages', (pages) => renderPages(pages));

        function renderGroups(groups) {
            const list = document.getElementById('groups-list');
            list.innerHTML = '';
            groups.forEach(g => {
                list.innerHTML += `
                <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px;">
                    <h4>${g.name}</h4>
                    <p style="font-size:12px; color:#aaa">${g.members.length} عضو</p>
                    <button class="btn-main" style="font-size:12px; padding:5px; margin-top:5px">دخول</button>
                </div>`;
            });
        }

        function renderPages(pages) {
            const list = document.getElementById('pages-list');
            list.innerHTML = '';
            pages.forEach(p => {
                list.innerHTML += `
                <div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid var(--glass-border)">
                    <div style="display:flex; gap:10px; align-items:center">
                        <div style="width:40px; height:40px; background:var(--accent); border-radius:8px"></div>
                        <div>
                            <h4>${p.name}</h4>
                            <small>${p.likes} إعجاب</small>
                        </div>
                    </div>
                    <button class="btn-main" style="width:auto; padding:5px 15px" onclick="socket.emit('like_page', '${p.id}')">إعجاب</button>
                </div>`;
            });
        }

        // --- CHAT & FRIENDS ---
        function addFriend() {
            const email = document.getElementById('friend-email').value;
            socket.emit('send_friend_request', { fromEmail: currentUser.email, toEmail: email });
            document.getElementById('friend-email').value = '';
            alert('تم إرسال الطلب');
        }

        socket.on('update_requests', (reqs) => {
            const list = document.getElementById('requests-list');
            list.innerHTML = reqs.length ? '' : '<p style="font-size:12px; color:var(--text-gray)">لا توجد طلبات</p>';
            reqs.forEach(r => {
                list.innerHTML += `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px">
                    <img src="${r.avatar}" class="avatar" style="width:30px; height:30px">
                    <div style="flex:1; font-size:12px">${r.name}</div>
                    <i class="fas fa-check" style="color:#10b981; cursor:pointer" onclick="resp('${r.email}', true)"></i>
                    <i class="fas fa-times" style="color:#ef4444; cursor:pointer" onclick="resp('${r.email}', false)"></i>
                </div>`;
            });
        });

        function resp(email, accept) {
            socket.emit('respond_friend_request', { userEmail: currentUser.email, requesterEmail: email, accept });
        }

        socket.on('update_friends', (friends) => {
            const list = document.getElementById('friends-list');
            list.innerHTML = '';
            friends.forEach(f => {
                list.innerHTML += `
                <div class="friend-card" onclick="openChat('${f.email}', '${f.name}')">
                    <img src="${f.avatar}" class="avatar" style="width:35px; height:35px">
                    <div style="flex:1">
                        <div style="font-size:14px">${f.name}</div>
                        <div style="font-size:10px; color:var(--text-gray)">${f.isOnline ? 'متصل' : 'غير متصل'}</div>
                    </div>
                    ${f.isOnline ? '<div class="status"></div>' : ''}
                </div>`;
            });
        });

        // Chat Logic
        function openChat(email, name) {
            currentChat = email;
            document.getElementById('chat-box').style.display = 'flex';
            document.getElementById('chat-name').innerText = name;
            document.getElementById('chat-msgs').innerHTML = '';
        }
        function toggleChat() { document.getElementById('chat-box').style.display = 'none'; }
        
        function handleMsg(e) {
            if(e.key === 'Enter') {
                const txt = document.getElementById('msg-input').value;
                socket.emit('private_message', { from: currentUser.email, to: currentChat, text: txt });
                document.getElementById('msg-input').value = '';
            }
        }

        socket.on('receive_private_message', (data) => {
            if((data.to === currentUser.email && data.from === currentChat) || (data.from === currentUser.email && data.to === currentChat)) {
                const box = document.getElementById('chat-msgs');
                box.innerHTML += `<div class="msg ${data.from === currentUser.email ? 'msg-me' : 'msg-other'}">${data.text}</div>`;
                box.scrollTop = box.scrollHeight;
            }
        });

    </script>
</body>
    </html>
