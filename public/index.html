<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blogane</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Restore Previous Glassmorphism Design --- */
        :root {
            --bg-deep: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.7);
            --primary: #8b5cf6; /* Violet */
            --primary-glow: rgba(139, 92, 246, 0.5);
            --secondary: #ec4899; /* Pink */
            --text: #f8fafc;
            --text-gray: #94a3b8;
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass: blur(12px);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: var(--text);
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* UI Elements */
        .btn { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border: none; padding: 8px 18px; border-radius: 12px;
            cursor: pointer; font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 15px var(--primary-glow);
        }
        .btn:active { transform: scale(0.96); }
        
        .card {
            background: var(--panel-bg); backdrop-filter: var(--glass);
            border: var(--glass-border); border-radius: 16px;
            padding: 15px; margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .input-box { 
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            padding: 12px; border-radius: 12px; color: white; outline: none; margin-bottom: 10px;
        }

        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }

        /* Comments Section (New Inline Design) */
        .comments-area {
            display: none; /* Hidden by default */
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px)} to {opacity:1; transform:translateY(0)} }
        
        .comment-item { display: flex; gap: 10px; margin-bottom: 10px; font-size: 13px; }
        .comment-box { background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 12px; flex: 1; }

        /* Chat Tabs */
        .chat-tabs { display: flex; gap: 10px; padding: 10px; background: transparent; }
        .chat-tab { flex: 1; text-align: center; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--text-gray); cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .chat-tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Private Chat List */
        .friend-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.03); margin-bottom: 8px; cursor: pointer; }
        .friend-item:hover { background: rgba(255,255,255,0.08); }
        .online-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; }

        /* Navigation */
        .bottom-nav { 
            height: 70px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px);
            display: flex; justify-content: space-around; align-items: center; 
            position: fixed; bottom: 0; width: 100%; z-index: 500; 
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .nav-item { color: var(--text-gray); font-size: 22px; text-align: center; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }

        /* Views */
        .view { display: none; height: 100%; overflow-y: auto; padding-bottom: 90px; scroll-behavior: smooth; }
        .view.active { display: block; }
        .header { padding: 15px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        /* Loaders & Modals */
        .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #1e293b; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }

        .post-img { width: 100%; border-radius: 10px; margin-top: 10px; max-height: 400px; object-fit: cover; }
        .actions { display: flex; gap: 25px; margin-top: 15px; color: var(--text-gray); }
        .act-btn { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .liked { color: #ef4444; }

        .msg-bubble { padding: 10px 15px; border-radius: 18px; max-width: 80%; margin-bottom: 8px; font-size: 14px; }
        .msg-me { background: var(--primary); align-self: flex-start; }
        .msg-other { background: #334155; align-self: flex-end; }
    </style>
</head>
<body>

    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: bold; color: white;" id="loader-text">...</p>
        <p id="loader-percent" style="font-size: 12px; color: #aaa;"></p>
    </div>

    <div class="modal-overlay" id="auth-modal" style="display: flex;">
        <div class="modal-box" style="text-align: center;">
            <h1 style="font-size: 32px; margin-bottom: 5px; color: var(--primary);">Blogane</h1>
            <div id="reg-fields" style="display: none;"><input type="text" id="reg-name" class="input-box" placeholder="الاسم"></div>
            <input type="email" id="email" class="input-box" placeholder="البريد">
            <input type="password" id="pass" class="input-box" placeholder="المرور">
            <button class="btn" style="width: 100%; margin-top:10px" onclick="auth()">دخول</button>
            <p style="margin-top: 20px; cursor: pointer; color: var(--secondary);" onclick="toggleAuth()">حساب جديد؟</p>
        </div>
    </div>

    <div class="modal-overlay" id="generic-modal"><div class="modal-box" id="modal-content"></div></div>

    <!-- 1. HOME -->
    <div id="view-home" class="view active">
        <div class="header">
            <h2>الرئيسية</h2><img src="" id="header-avatar" class="avatar" onclick="navTo('profile')">
        </div>
        <div id="ctx-banner" style="display:none; padding:15px; background:linear-gradient(to right, var(--primary), var(--secondary)); text-align:center;">
            <h3 id="ctx-title" style="color:white;"></h3>
            <button id="ctx-del" class="btn" style="background:#ef4444; font-size:12px; display:none" onclick="deleteContext()">حذف</button>
            <button class="btn" style="background:rgba(0,0,0,0.3); font-size:12px" onclick="leaveContext()">خروج</button>
        </div>
        <div style="padding: 15px;">
            <div class="card">
                <div style="display:flex; gap:10px"><img src="" id="my-avatar" class="avatar"><input type="text" id="post-txt" class="input-box" style="margin:0; border-radius:25px" placeholder="بماذا تفكر؟"></div>
                <div style="display:flex; justify-content:space-between; margin-top:15px">
                    <label style="color:#10b981; cursor:pointer; display:flex; align-items:center; gap:5px"><i class="fas fa-image"></i> صورة<input type="file" id="post-img" hidden></label>
                    <button class="btn" onclick="publishPost()">نشر</button>
                </div>
                <div id="post-preview"></div>
            </div>
            <div id="feed"></div>
        </div>
    </div>

    <!-- 2. EXPLORE -->
    <div id="view-explore" class="view">
        <div class="header"><h2>استكشف</h2></div>
        <div style="padding: 15px;">
            <div style="display:flex; gap:10px; margin-bottom:20px"><button class="btn" onclick="promptCreate('group')">مجموعة +</button><button class="btn" style="background:var(--secondary)" onclick="promptCreate('page')">صفحة +</button></div>
            <h4 style="color:#aaa">المجموعات</h4><div id="groups-list"></div>
            <h4 style="color:#aaa; margin-top:20px">الصفحات</h4><div id="pages-list"></div>
        </div>
    </div>

    <!-- 3. REELS -->
    <div id="view-reels" class="view" style="background: black;">
        <div style="position:absolute; top:20px; left:20px; z-index:100"><button class="btn" style="background:rgba(255,255,255,0.2); backdrop-filter:blur(5px)" onclick="showReelModal()">+ فيديو</button></div>
        <div id="reels-container" style="height:100%; overflow-y:scroll; scroll-snap-type:y mandatory"></div>
    </div>

    <!-- 4. CHAT -->
    <div id="view-chat" class="view">
        <div class="header"><h2>الدردشة</h2></div>
        <div class="chat-tabs">
            <div class="chat-tab active" onclick="switchChat('global')" id="tab-global">عامة</div>
            <div class="chat-tab" onclick="switchChat('private')" id="tab-private">الخاص</div>
            <div class="chat-tab" onclick="switchChat('ai')" id="tab-ai">AI</div>
        </div>
        
        <!-- Global -->
        <div id="chat-global" style="height:calc(100% - 130px); display:flex; flex-direction:column;">
            <div id="g-msgs" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column"></div>
            <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="g-input" class="input-box" style="margin:0" placeholder="رسالة..."><button class="btn" onclick="sendGlobal()">➤</button></div>
        </div>
        
        <!-- Private -->
        <div id="chat-private" style="height:calc(100% - 130px); display:none; flex-direction:column;">
            <!-- List of Friends -->
            <div id="friends-list-view" style="padding:15px; flex:1; overflow-y:auto"></div>
            <!-- Conversation View -->
            <div id="private-conversation" style="display:none; height:100%; flex-direction:column;">
                <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; align-items:center; gap:10px">
                    <button class="btn" style="padding:5px 10px" onclick="backToFriends()">➜</button>
                    <b id="p-chat-name">Name</b>
                </div>
                <div id="p-msgs" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column"></div>
                <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="p-input" class="input-box" style="margin:0" placeholder="رسالة خاصة..."><button class="btn" onclick="sendPrivate()">➤</button></div>
            </div>
        </div>

        <!-- AI -->
        <div id="chat-ai" style="height:calc(100% - 130px); display:none; flex-direction:column;">
            <div id="ai-msgs" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column"></div>
            <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="ai-input" class="input-box" style="margin:0" placeholder="اسأل..."><button class="btn" onclick="sendAi()">➤</button></div>
        </div>
    </div>

    <!-- 5. PROFILE -->
    <div id="view-profile" class="view">
        <div style="padding:40px 20px 20px; text-align:center; background:linear-gradient(to bottom, var(--primary), transparent)">
            <img src="" id="p-avatar" class="avatar" style="width:90px; height:90px; border:4px solid var(--bg-deep)">
            <h2 id="p-name" style="margin-top:10px"></h2>
            <button class="btn" style="background:rgba(255,255,255,0.2); margin-top:10px" onclick="showEditProfile()">تعديل</button>
        </div>
        <div id="profile-posts" style="padding:15px"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i><span>الرئيسية</span></div>
        <div class="nav-item" onclick="navTo('explore', this)"><i class="fas fa-compass"></i><span>استكشف</span></div>
        <div class="nav-item" onclick="navTo('reels', this)"><i class="fas fa-play-circle"></i><span>ريلز</span></div>
        <div class="nav-item" onclick="navTo('chat', this)"><i class="fas fa-comments"></i><span>الدردشة</span></div>
        <div class="nav-item" onclick="navTo('profile', this)"><i class="fas fa-user"></i><span>ملفي</span></div>
    </nav>

    <script>
        const socket = io();
        let currentUser = null;
        let currentContext = 'general';
        let currentContextId = null;
        let currentContextOwner = null;
        let currentPrivateChatEmail = null;
        let isReg = false;

        // Auto Login
        window.onload = () => {
            const saved = localStorage.getItem('blogane_u');
            if(saved) socket.emit('login', JSON.parse(saved));
        }

        function showLoader(t) { document.getElementById('loader-text').innerText=t; document.getElementById('loader-percent').innerText=''; document.getElementById('loader').style.display='flex'; }
        function hideLoader() { document.getElementById('loader').style.display='none'; }
        function showModal(h) { document.getElementById('modal-content').innerHTML=h; document.getElementById('generic-modal').style.display='flex'; }
        function closeModal() { document.getElementById('generic-modal').style.display='none'; }

        function navTo(v, el) {
            document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            if(el) el.classList.add('active'); else if(v==='profile') document.querySelector('.nav-item:last-child').classList.add('active');
            if(v==='profile') socket.emit('get_user_posts', currentUser.email);
        }

        // Auth
        function toggleAuth() { isReg=!isReg; document.getElementById('reg-fields').style.display=isReg?'block':'none'; }
        function auth() {
            const email=document.getElementById('email').value, pass=document.getElementById('pass').value;
            if(email && pass) {
                if(isReg) socket.emit('register', { name:document.getElementById('reg-name').value, email, password:pass });
                else socket.emit('login', { email, password:pass });
            }
        }
        socket.on('auth_success', (u) => { 
            currentUser=u; 
            localStorage.setItem('blogane_u', JSON.stringify({email:u.email, password:u.password})); 
            document.getElementById('auth-modal').style.display='none'; 
            updateUI(); 
        });
        function updateUI() {
            document.getElementById('my-avatar').src=currentUser.avatar;
            document.getElementById('header-avatar').src=currentUser.avatar;
            document.getElementById('p-avatar').src=currentUser.avatar;
            document.getElementById('p-name').innerText=currentUser.name;
        }

        // Posts
        let postImg=null;
        document.getElementById('post-img').addEventListener('change', function(){ const f=this.files[0]; if(f){const r=new FileReader(); r.onload=(e)=>{postImg=e.target.result; document.getElementById('post-preview').innerHTML=`<img src="${postImg}" style="height:80px;border-radius:10px;margin-top:10px">`}; r.readAsDataURL(f);} });
        function publishPost() {
            const t=document.getElementById('post-txt').value; if(!t&&!postImg)return;
            showLoader('جاري النشر...');
            socket.emit('new_post', {content:t, media:postImg, author:currentUser.name, email:currentUser.email, avatar:currentUser.avatar, context:currentContext, contextId:currentContextId});
            document.getElementById('post-txt').value=''; document.getElementById('post-preview').innerHTML=''; postImg=null;
        }
        socket.on('upload_complete', () => { hideLoader(); closeModal(); });

        function renderPost(p, t) {
            const l = p.likes.includes(currentUser.email);
            const commentHtml = p.comments.map(c => `<div class="comment-item"><img src="${c.userAvatar}" class="avatar" style="width:25px;height:25px"> <div class="comment-box"><b>${c.userName}</b><br>${c.text}</div></div>`).join('');
            
            const html = `
            <div class="card">
                <div style="display:flex; gap:10px; align-items:center"><img src="${p.avatar}" class="avatar"><div><b>${p.author}</b><br><small style="color:#aaa">${new Date(p.date).toLocaleTimeString()}</small></div></div>
                <p style="margin-top:10px; line-height:1.5">${p.content||''}</p>
                ${p.media?`<img src="${p.media}" class="post-img">`:''}
                <div class="actions">
                    <div class="act-btn ${l?'liked':''}" onclick="socket.emit('toggle_like',{id:${p.id},type:'post',userEmail:currentUser.email})"><i class="${l?'fas':'far'} fa-heart"></i> <span id="l-${p.id}">${p.likes.length}</span></div>
                    <div class="act-btn" onclick="toggleComments(${p.id})"><i class="far fa-comment"></i> <span>${p.comments.length}</span></div>
                </div>
                <div class="comments-area" id="comments-${p.id}">
                    <div id="clist-${p.id}">${commentHtml}</div>
                    <div style="display:flex; gap:5px; margin-top:10px">
                        <input id="cin-${p.id}" class="input-box" style="margin:0; padding:8px" placeholder="اكتب تعليقاً...">
                        <button class="btn" style="padding:5px 10px" onclick="sendComment(${p.id})">➤</button>
                    </div>
                </div>
            </div>`;
            document.getElementById(t).insertAdjacentHTML('afterbegin', html);
        }
        
        // Toggle Inline Comments
        window.toggleComments = (id) => {
            const el = document.getElementById(`comments-${id}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }
        window.sendComment = (id) => {
            const txt = document.getElementById(`cin-${id}`).value;
            if(txt) { socket.emit('add_comment', {postId:id, text:txt, userEmail:currentUser.email, userName:currentUser.name, userAvatar:currentUser.avatar}); document.getElementById(`cin-${id}`).value=''; }
        }
        socket.on('update_comments', (d) => {
            const list = document.getElementById(`clist-${d.postId}`);
            if(list) list.innerHTML = d.comments.map(c => `<div class="comment-item"><img src="${c.userAvatar}" class="avatar" style="width:25px;height:25px"> <div class="comment-box"><b>${c.userName}</b><br>${c.text}</div></div>`).join('');
        });
        
        socket.on('receive_post', (p) => { if(p.context===currentContext && p.contextId===currentContextId) renderPost(p,'feed'); });
        socket.on('load_posts', (ps) => { document.getElementById('feed').innerHTML=''; ps.reverse().forEach(p=>renderPost(p,'feed')); });
        socket.on('load_profile_posts', (ps) => { document.getElementById('profile-posts').innerHTML=''; ps.reverse().forEach(p=>renderPost(p,'profile-posts')); });
        socket.on('update_likes', (d) => { const e=document.getElementById((d.type==='reel'?'rl-':'l-')+d.id); if(e)e.innerText=d.likes.length; });

        // Chat System
        function switchChat(t) {
            document.getElementById('chat-global').style.display=t==='global'?'flex':'none';
            document.getElementById('chat-private').style.display=t==='private'?'flex':'none';
            document.getElementById('chat-ai').style.display=t==='ai'?'flex':'none';
            document.querySelectorAll('.chat-tab').forEach(x=>x.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
        }
        
        // Global
        function sendGlobal(){ const t=document.getElementById('g-input').value; if(t){socket.emit('send_global_msg',{text:t,author:currentUser.name,email:currentUser.email,avatar:currentUser.avatar});document.getElementById('g-input').value='';} }
        socket.on('receive_global_msg', (m)=>{ document.getElementById('g-msgs').innerHTML+=`<div style="display:flex;flex-direction:column;align-items:${m.email===currentUser.email?'flex-start':'flex-end'}"><div class="msg-bubble ${m.email===currentUser.email?'msg-me':'msg-other'}"><b>${m.author}</b>: ${m.text}</div></div>`; });

        // Private
        socket.on('update_friends', (friends) => {
            document.getElementById('friends-list-view').innerHTML = friends.map(f => `
                <div class="friend-item" onclick="openPrivateChat('${f.email}', '${f.name}')">
                    <img src="${f.avatar}" class="avatar">
                    <div style="flex:1"><b>${f.name}</b><br><small style="color:${f.isOnline?'#10b981':'#aaa'}">● ${f.isOnline?'متصل':'غير متصل'}</small></div>
                </div>
            `).join('');
        });
        function openPrivateChat(email, name) {
            currentPrivateChatEmail = email;
            document.getElementById('friends-list-view').style.display='none';
            document.getElementById('private-conversation').style.display='flex';
            document.getElementById('p-chat-name').innerText = name;
            document.getElementById('p-msgs').innerHTML = 'جاري التحميل...';
            socket.emit('get_private_msgs', { user1: currentUser.email, user2: email });
        }
        function backToFriends() {
            document.getElementById('friends-list-view').style.display='block';
            document.getElementById('private-conversation').style.display='none';
            currentPrivateChatEmail = null;
        }
        function sendPrivate() {
            const t = document.getElementById('p-input').value;
            if(t && currentPrivateChatEmail) {
                socket.emit('send_private_msg', { from: currentUser.email, to: currentPrivateChatEmail, text: t });
                document.getElementById('p-input').value = '';
            }
        }
        socket.on('load_private_msgs', (msgs) => {
            document.getElementById('p-msgs').innerHTML = msgs.map(m => {
                const me = m.from === currentUser.email;
                return `<div style="display:flex;flex-direction:column;align-items:${me?'flex-start':'flex-end'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}">${m.text}</div></div>`;
            }).join('');
        });
        socket.on('receive_private_msg', (m) => {
            if (currentPrivateChatEmail && (m.from === currentPrivateChatEmail || m.from === currentUser.email)) {
                const me = m.from === currentUser.email;
                document.getElementById('p-msgs').innerHTML += `<div style="display:flex;flex-direction:column;align-items:${me?'flex-start':'flex-end'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}">${m.text}</div></div>`;
                document.getElementById('p-msgs').scrollTop = document.getElementById('p-msgs').scrollHeight;
            }
        });

        // AI
        function sendAi(){ const t=document.getElementById('ai-input').value; if(t){ document.getElementById('ai-msgs').innerHTML+=`<div class="msg-bubble msg-me">${t}</div>`; socket.emit('send_ai_msg', t); document.getElementById('ai-input').value=''; } }
        socket.on('receive_ai_msg', (m)=>{ document.getElementById('ai-msgs').innerHTML+=`<div class="msg-bubble msg-other">${m.text}</div>`; });

        // Context (Groups/Pages)
        function enterContext(t,i,n,o){ currentContext=t;currentContextId=i;currentContextOwner=o; navTo('home'); document.getElementById('ctx-banner').style.display='block'; document.getElementById('ctx-title').innerText=n; document.getElementById('feed').innerHTML=''; socket.emit('get_context_posts',{context:t,contextId:i}); document.getElementById('ctx-del').style.display=(currentUser.email===o?'inline-block':'none'); }
        function leaveContext(){ currentContext='general';currentContextId=null; document.getElementById('ctx-banner').style.display='none'; document.getElementById('feed').innerHTML=''; socket.emit('get_context_posts',{context:'general',contextId:null}); }
        function deleteContext(){ if(confirm('حذف نهائي؟')){ if(currentContext==='group')socket.emit('delete_group',{groupId:currentContextId,email:currentUser.email}); else socket.emit('delete_page',{pageId:currentContextId,email:currentUser.email}); } }
        socket.on('delete_success', ()=>{ alert('تم الحذف'); leaveContext(); });

        // Init
        socket.on('init_data', (d) => {
            document.getElementById('groups-list').innerHTML = d.groups.map(g=>`<div class="card" style="padding:10px; cursor:pointer" onclick="enterContext('group','${g.id}','${g.name}','${g.owner}')"><b>${g.name}</b></div>`).join('');
            document.getElementById('pages-list').innerHTML = d.pages.map(p=>`<div class="card" style="padding:10px; cursor:pointer" onclick="enterContext('page','${p.id}','${p.name}','${p.owner}')"><b>${p.name}</b></div>`).join('');
            d.reels.forEach(r => {
                const h = `<div class="reel-item" style="height:calc(100vh - 70px); background:#000; position:relative; scroll-snap-align:start; display:flex; justify-content:center"><video src="${r.url}" controls style="width:100%;height:100%;object-fit:contain"></video><div style="position:absolute;bottom:20px;right:20px;text-align:right"><b>${r.author}</b><br>${r.desc}</div></div>`;
                document.getElementById('reels-container').insertAdjacentHTML('beforeend', h);
            });
        });

        // Reels Upload
        function showReelModal(){ showModal(`<h3>نشر فيديو</h3><input type="file" id="reel-file" class="input-box" accept="video/*"><input type="text" id="reel-desc" class="input-box" placeholder="وصف"><button class="btn" style="width:100%" onclick="upReel()">نشر</button><button class="btn" style="width:100%;background:none;margin-top:5px" onclick="closeModal()">إلغاء</button>`); }
        async function upReel(){
            const f=document.getElementById('reel-file').files[0], d=document.getElementById('reel-desc').value; if(!f)return;
            showLoader('جاري الرفع...');
            socket.emit('upload_reel_start', {name:f.name});
            const CHUNK=500*1024, total=Math.ceil(f.size/CHUNK);
            socket.once('upload_ready', async ({tempFileName}) => {
                for(let i=0; i<total; i++){
                    socket.emit('upload_reel_chunk', {fileName:tempFileName, data:await f.slice(i*CHUNK,(i+1)*CHUNK).arrayBuffer()});
                }
                socket.emit('upload_reel_end', {fileName:tempFileName, desc:d, author:currentUser.name, avatar:currentUser.avatar, email:currentUser.email});
            });
        }
        socket.on('receive_reel', (r) => {
            const h = `<div class="reel-item" style="height:calc(100vh - 70px); background:#000; position:relative; scroll-snap-align:start; display:flex; justify-content:center"><video src="${r.url}" controls style="width:100%;height:100%;object-fit:contain"></video><div style="position:absolute;bottom:20px;right:20px;text-align:right"><b>${r.author}</b><br>${r.desc}</div></div>`;
            document.getElementById('reels-container').insertAdjacentHTML('afterbegin', h);
        });

        // Misc
        function promptCreate(t){ const n=prompt('الاسم:'); if(n) t==='group'?socket.emit('create_group',{name:n,desc:'',owner:currentUser.email}):socket.emit('create_page',{name:n,owner:currentUser.email}); }
        function showEditProfile(){ showModal(`<h3>تعديل</h3><input id="e-n" class="input-box" value="${currentUser.name}"><button class="btn" onclick="saveProf()">حفظ</button><button class="btn" style="background:none" onclick="closeModal()">إلغاء</button>`); }
        function saveProf(){ socket.emit('update_profile',{email:currentUser.email, name:document.getElementById('e-n').value}); closeModal(); }
        socket.on('profile_updated_success', (u)=>{ currentUser=u; updateUI(); });
        function addFriend(){ socket.emit('send_friend_request', {from:currentUser.email, to:document.getElementById('friend-email').value}); document.getElementById('friend-email').value=''; alert('تم الإرسال'); }
    </script>
</body>
            </html>
