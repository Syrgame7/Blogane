<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blogane Live</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f172a;
            --panel: rgba(30, 41, 59, 0.75);
            --primary: #8b5cf6;
            --accent: #ec4899;
            --text: #f8fafc;
            --gray: #94a3b8;
            --glass: blur(16px);
            --border: 1px solid rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg);
            background-image: radial-gradient(circle at 10% 10%, rgba(139, 92, 246, 0.2) 0%, transparent 40%), radial-gradient(circle at 90% 90%, rgba(236, 72, 153, 0.2) 0%, transparent 40%);
            color: var(--text);
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* Components */
        .btn { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; padding: 8px 16px; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3); transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .card { background: var(--panel); backdrop-filter: var(--glass); border: var(--border); border-radius: 18px; padding: 15px; margin-bottom: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .input-box { width: 100%; background: rgba(0,0,0,0.3); border: var(--border); padding: 12px; border-radius: 12px; color: white; outline: none; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }

        /* Nav & Header */
        .bottom-nav { height: 70px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; width: 100%; z-index: 500; border-top: var(--border); padding-bottom: 5px; }
        .nav-item { color: var(--gray); font-size: 24px; text-align: center; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .header { padding: 15px 20px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: var(--border); }

        /* Posts & Comments */
        .post-img { width: 100%; border-radius: 12px; margin-top: 10px; max-height: 400px; object-fit: cover; }
        .actions { display: flex; gap: 20px; margin-top: 15px; border-top: var(--border); padding-top: 10px; color: var(--gray); }
        .act-btn { cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 14px; }
        .liked { color: #ef4444; }
        
        .comments-section { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(-10px)} to {opacity:1; transform:translateY(0)} }
        .comment-item { display: flex; gap: 10px; margin-bottom: 10px; font-size: 13px; }
        .comment-bubble { background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 12px; flex: 1; }

        /* Chat */
        .chat-tabs { display: flex; gap: 10px; padding: 10px; }
        .chat-tab { flex: 1; text-align: center; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.05); color: var(--gray); cursor: pointer; border: var(--border); font-weight: bold; }
        .chat-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .msg-bubble { padding: 10px 15px; border-radius: 18px; max-width: 75%; margin-bottom: 8px; font-size: 14px; }
        .msg-me { background: linear-gradient(135deg, var(--primary), #4f46e5); align-self: flex-start; }
        .msg-other { background: #334155; align-self: flex-end; }
        .friend-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.03); margin-bottom: 8px; cursor: pointer; }

        /* Views */
        .view { display: none; height: 100%; overflow-y: auto; padding-bottom: 90px; }
        .view.active { display: block; }
        
        /* Loader */
        .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="loader-overlay" id="loader"><div class="spinner"></div><p style="margin-top:15px; color:white">جاري العمل...</p></div>

    <!-- Auth -->
    <div id="auth-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; display:flex; justify-content:center; align-items:center;">
        <div class="card" style="width:90%; max-width:400px; text-align:center;">
            <h1 style="font-size:32px; color:var(--primary); margin-bottom:10px">Blogane</h1>
            <div id="reg-fields" style="display:none"><input id="reg-name" class="input-box" placeholder="الاسم" style="margin-bottom:10px"></div>
            <input id="email" class="input-box" placeholder="البريد" style="margin-bottom:10px">
            <input id="pass" type="password" class="input-box" placeholder="كلمة المرور" style="margin-bottom:15px">
            <button class="btn" style="width:100%" onclick="auth()">دخول</button>
            <p style="margin-top:15px; cursor:pointer; color:var(--accent)" onclick="toggleAuth()">حساب جديد؟</p>
        </div>
    </div>

    <!-- HOME -->
    <div id="view-home" class="view active">
        <div class="header"><h2>الرئيسية</h2><img src="" id="header-avatar" class="avatar" onclick="navTo('profile')"></div>
        <div style="padding: 15px;">
            <div class="card">
                <div style="display:flex; gap:10px"><img src="" id="my-avatar" class="avatar"><input id="post-txt" class="input-box" style="border-radius:25px" placeholder="بماذا تفكر؟"></div>
                <div style="display:flex; justify-content:space-between; margin-top:15px">
                    <label style="color:#10b981; cursor:pointer; display:flex; align-items:center; gap:5px"><i class="fas fa-image"></i> صورة<input type="file" id="post-img" hidden></label>
                    <button class="btn" onclick="publishPost()">نشر</button>
                </div>
            </div>
            <div id="feed"></div>
        </div>
    </div>

    <!-- CHAT -->
    <div id="view-chat" class="view">
        <div class="header"><h2>الدردشة</h2></div>
        <div class="chat-tabs">
            <div class="chat-tab active" onclick="switchChat('global')" id="tab-global">عامة</div>
            <div class="chat-tab" onclick="switchChat('private')" id="tab-private">الأصدقاء</div>
            <div class="chat-tab" onclick="switchChat('ai')" id="tab-ai">AI</div>
        </div>
        
        <!-- Global -->
        <div id="chat-global" style="height:calc(100% - 130px); display:flex; flex-direction:column;">
            <div id="g-msgs" style="flex:1; overflow-y:auto; padding:15px"></div>
            <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="g-input" class="input-box" placeholder="اكتب..."><button class="btn" onclick="sendGlobal()">➤</button></div>
        </div>

        <!-- Private -->
        <div id="chat-private" style="height:calc(100% - 130px); display:none; flex-direction:column;">
            <div id="friends-list-view" style="padding:15px; flex:1; overflow-y:auto"></div>
            <div id="private-conversation" style="display:none; height:100%; flex-direction:column;">
                <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px; align-items:center">
                    <button class="btn" style="padding:5px 10px" onclick="backToFriends()">➜</button> <b id="p-chat-name"></b>
                </div>
                <div id="p-msgs" style="flex:1; overflow-y:auto; padding:15px"></div>
                <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="p-input" class="input-box" placeholder="رسالة خاصة..."><button class="btn" onclick="sendPrivate()">➤</button></div>
            </div>
        </div>

        <!-- AI -->
        <div id="chat-ai" style="height:calc(100% - 130px); display:none; flex-direction:column;">
            <div id="ai-msgs" style="flex:1; overflow-y:auto; padding:15px"></div>
            <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="ai-input" class="input-box" placeholder="اسأل AI..."><button class="btn" onclick="sendAi()">➤</button></div>
        </div>
    </div>

    <!-- (Reels, Explore, Profile - Keep simple for brevity, same logic) -->
    <!-- ... -->

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i></div>
        <div class="nav-item" onclick="navTo('chat', this)"><i class="fas fa-comments"></i></div>
        <!-- Add other nav items as needed -->
    </nav>

    <script>
        const socket = io();
        let currentUser = null;
        let isReg = false;
        let currentPrivateChat = null;

        window.onload = () => { const s=localStorage.getItem('u'); if(s) socket.emit('login', JSON.parse(s)); }

        function navTo(v, el) {
            document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            if(el) el.classList.add('active');
        }

        // Auth
        function toggleAuth(){isReg=!isReg;document.getElementById('reg-fields').style.display=isReg?'block':'none';}
        function auth(){
            const e=document.getElementById('email').value, p=document.getElementById('pass').value;
            if(isReg) socket.emit('register', {name:document.getElementById('reg-name').value, email:e, password:p});
            else socket.emit('login', {email:e, password:p});
        }
        socket.on('auth_success', (u) => {
            currentUser=u; localStorage.setItem('u', JSON.stringify({email:u.email, password:u.password}));
            document.getElementById('auth-modal').style.display='none';
            document.getElementById('my-avatar').src=u.avatar;
            document.getElementById('header-avatar').src=u.avatar;
        });

        // Posts & Inline Comments
        function publishPost() {
            const t=document.getElementById('post-txt').value; 
            if(t) { socket.emit('new_post', {content:t, media:null, author:currentUser.name, email:currentUser.email, avatar:currentUser.avatar, context:'general', contextId:null}); document.getElementById('post-txt').value=''; }
        }
        
        socket.on('receive_post', (p) => {
            const l = p.likes.includes(currentUser?currentUser.email:'');
            const html = `
            <div class="card">
                <div style="display:flex; gap:10px; align-items:center"><img src="${p.avatar}" class="avatar"><div><b>${p.author}</b><br><small style="color:var(--gray); font-size:12px">الآن</small></div></div>
                <p style="margin-top:10px">${p.content}</p>
                <div class="actions">
                    <div class="act-btn ${l?'liked':''}" onclick="socket.emit('toggle_like',{id:${p.id},type:'post',userEmail:currentUser.email})"><i class="${l?'fas':'far'} fa-heart"></i> <span id="l-${p.id}">${p.likes.length}</span></div>
                    <div class="act-btn" onclick="toggleCom(${p.id})"><i class="far fa-comment"></i> <span>${p.comments.length}</span></div>
                </div>
                <div class="comments-section" id="com-${p.id}">
                    <div id="clist-${p.id}"></div>
                    <div style="display:flex; gap:5px; margin-top:10px"><input id="cin-${p.id}" class="input-box" style="padding:8px" placeholder="تعليق.."><button class="btn" style="padding:5px 10px" onclick="sendCom(${p.id})">➤</button></div>
                </div>
            </div>`;
            document.getElementById('feed').insertAdjacentHTML('afterbegin', html);
        });

        window.toggleCom = (id) => { const el=document.getElementById(`com-${id}`); el.style.display = el.style.display==='none'?'block':'none'; }
        window.sendCom = (id) => { const t=document.getElementById(`cin-${id}`).value; if(t) { socket.emit('add_comment', {postId:id, text:t, userEmail:currentUser.email, userName:currentUser.name, userAvatar:currentUser.avatar}); document.getElementById(`cin-${id}`).value=''; } }
        
        socket.on('update_comments', (d) => {
            const list = document.getElementById(`clist-${d.postId}`);
            if(list) list.innerHTML = d.comments.map(c=>`<div class="comment-item"><img src="${c.userAvatar}" class="avatar" style="width:25px;height:25px"><div class="comment-bubble"><b>${c.userName}</b><br>${c.text}</div></div>`).join('');
        });
        socket.on('update_likes', (d)=>{ const e=document.getElementById(`l-${d.id}`); if(e)e.innerText=d.likes.length; });

        // Chat Logic
        function switchChat(t) {
            ['global','private','ai'].forEach(x => document.getElementById(`chat-${x}`).style.display = x===t?'flex':'none');
            document.querySelectorAll('.chat-tab').forEach(x=>x.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
        }
        function sendGlobal() { const t=document.getElementById('g-input').value; if(t){socket.emit('send_global_msg',{text:t, author:currentUser.name, email:currentUser.email, avatar:currentUser.avatar}); document.getElementById('g-input').value='';} }
        socket.on('receive_global_msg', (m)=>{ 
            const me = m.email === currentUser.email;
            document.getElementById('g-msgs').innerHTML += `<div style="text-align:${me?'left':'right'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}"><b>${m.author}</b>: ${m.text}</div></div>`; 
        });

        // Private
        socket.on('update_friends', (f) => {
            document.getElementById('friends-list-view').innerHTML = f.map(u => `<div class="friend-item" onclick="openPriv('${u.email}','${u.name}')"><img src="${u.avatar}" class="avatar"> ${u.name}</div>`).join('');
        });
        function openPriv(e,n) { currentPrivateChat=e; document.getElementById('friends-list-view').style.display='none'; document.getElementById('private-conversation').style.display='flex'; document.getElementById('p-chat-name').innerText=n; socket.emit('get_private_msgs',{user1:currentUser.email, user2:e}); }
        function backToFriends() { document.getElementById('friends-list-view').style.display='block'; document.getElementById('private-conversation').style.display='none'; currentPrivateChat=null; }
        function sendPrivate() { const t=document.getElementById('p-input').value; if(t && currentPrivateChat) { socket.emit('send_private_msg',{from:currentUser.email, to:currentPrivateChat, text:t}); document.getElementById('p-input').value=''; } }
        socket.on('load_private_msgs', (m) => { document.getElementById('p-msgs').innerHTML = m.map(x=>`<div class="msg-bubble ${x.from===currentUser.email?'msg-me':'msg-other'}">${x.text}</div>`).join(''); });
        socket.on('receive_private_msg', (m) => { if(m.from===currentPrivateChat || m.from===currentUser.email) document.getElementById('p-msgs').innerHTML+=`<div class="msg-bubble ${m.from===currentUser.email?'msg-me':'msg-other'}">${m.text}</div>`; });

        // AI
        function sendAi(){ const t=document.getElementById('ai-input').value; if(t){ document.getElementById('ai-msgs').innerHTML+=`<div class="msg-bubble msg-me">${t}</div>`; socket.emit('send_ai_msg', t); document.getElementById('ai-input').value=''; } }
        socket.on('receive_ai_msg', (m)=>{ document.getElementById('ai-msgs').innerHTML+=`<div class="msg-bubble msg-other">${m.text}</div>`; });

        // Init
        socket.on('init_data', (d)=>{ /* Same old init logic */ });
        socket.on('load_posts', (ps)=>{ document.getElementById('feed').innerHTML=''; ps.reverse().forEach(p=>renderPost(p,'feed')); }); // Render reused
    </script>
</body>
</html>
