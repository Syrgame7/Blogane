<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blogane Ultimate</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #020617;
            --panel: #1e293b;
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #f43f5e;
            --text: #f1f5f9;
            --text-sec: #94a3b8;
            --border: 1px solid rgba(255,255,255,0.08);
            --glass: blur(12px);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg);
            background-image: radial-gradient(circle at top right, #1e1b4b 0%, transparent 40%), radial-gradient(circle at bottom left, #312e81 0%, transparent 40%);
            color: var(--text);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- Atomic Classes --- */
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }
        .btn { 
            background: linear-gradient(135deg, var(--primary), var(--accent)); 
            color: white; border: none; padding: 10px 20px; border-radius: 14px; 
            font-weight: 700; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        .btn:active { transform: scale(0.95); }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        
        /* --- Components --- */
        .card {
            background: rgba(30, 41, 59, 0.6); backdrop-filter: var(--glass);
            border: var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px;
        }
        .input-box {
            width: 100%; background: rgba(0,0,0,0.3); border: var(--border);
            padding: 12px 15px; border-radius: 12px; color: white; outline: none; transition: 0.3s;
        }
        .input-box:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }

        /* --- Layout --- */
        .header { 
            padding: 15px 20px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100; border-bottom: var(--border);
        }
        .view { display: none; height: 100%; overflow-y: auto; padding-bottom: 90px; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* --- Bottom Nav --- */
        .bottom-nav {
            height: 75px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
            position: fixed; bottom: 0; width: 100%; z-index: 500;
            border-top: var(--border); border-radius: 20px 20px 0 0;
        }
        .nav-item { color: var(--text-sec); font-size: 22px; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); text-shadow: 0 0 15px var(--primary); }
        .badge { position: absolute; top: -5px; right: -8px; background: var(--accent); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; }

        /* --- Post & Comments --- */
        .post-header { cursor: pointer; }
        .post-header:hover b { color: var(--primary); text-decoration: underline; }
        .comments-section { display: none; margin-top: 15px; padding-top: 15px; border-top: var(--border); }
        .comment-item { display: flex; gap: 10px; margin-bottom: 10px; font-size: 13px; }
        .comment-bubble { background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 12px; flex: 1; }

        /* --- Chat --- */
        .chat-tabs { padding: 10px; background: transparent; gap: 10px; }
        .chat-tab { flex: 1; text-align: center; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.05); color: var(--text-sec); border: var(--border); cursor: pointer; }
        .chat-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .msg-bubble { padding: 10px 15px; border-radius: 18px; max-width: 80%; margin-bottom: 8px; font-size: 14px; }
        .msg-me { background: var(--primary-dark); align-self: flex-start; border-bottom-right-radius: 4px; }
        .msg-other { background: #334155; align-self: flex-end; border-bottom-left-radius: 4px; }

        /* --- Profile Page --- */
        .profile-cover { height: 160px; background: linear-gradient(45deg, var(--primary), var(--accent)); border-radius: 0 0 30px 30px; position: relative; margin-bottom: 60px; }
        .profile-pic-lg { width: 110px; height: 110px; border-radius: 50%; border: 5px solid var(--bg); position: absolute; bottom: -55px; right: 50%; transform: translateX(50%); object-fit: cover; }
        
        /* --- Modal & Loader --- */
        .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to {transform: rotate(360deg)} }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .modal-box { background: #1e293b; width: 90%; max-width: 400px; padding: 25px; border-radius: 24px; border: var(--border); }
    </style>
</head>
<body>

    <div class="loader-overlay" id="loader"><div class="spinner"></div><p style="margin-top:15px;color:white">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="auth-modal" style="display: flex;">
        <div class="modal-box" style="text-align: center;">
            <h1 style="font-size: 35px; margin-bottom: 10px; color: var(--primary);">Blogane</h1>
            <div id="reg-fields" style="display:none"><input id="reg-name" class="input-box" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" style="margin-bottom:10px"></div>
            <input id="email" class="input-box" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="margin-bottom:10px">
            <input id="pass" type="password" class="input-box" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom:15px">
            <button class="btn" style="width:100%" onclick="auth()">Ø¯Ø®ÙˆÙ„</button>
            <p style="margin-top:20px; cursor:pointer; color:var(--text-sec)" onclick="toggleAuth()">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</p>
        </div>
    </div>

    <div class="modal-overlay" id="generic-modal"><div class="modal-box" id="modal-content"></div></div>

    <!-- VIEW 1: HOME -->
    <div id="view-home" class="view active">
        <div class="header flex-between">
            <h2>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
            <img src="" id="header-avatar" class="avatar" onclick="openProfile(currentUser.email)">
        </div>
        <div style="padding: 15px;">
            <div class="card">
                <div class="flex-center" style="gap:10px"><img src="" id="my-avatar" class="avatar"><input id="post-txt" class="input-box" style="border-radius:30px; border:none; background:rgba(255,255,255,0.05)" placeholder="Ø¨Ù…Ø§Ø°Ø§ ØªÙÙƒØ±ØŸ"></div>
                <div class="flex-between" style="margin-top:15px">
                    <label style="color:#34d399; cursor:pointer; font-weight:bold" class="flex-center"><i class="fas fa-image" style="margin-left:5px"></i> ØµÙˆØ±Ø©<input type="file" id="post-img" hidden></label>
                    <button class="btn" style="padding:6px 20px" onclick="publishPost()">Ù†Ø´Ø±</button>
                </div>
                <div id="post-preview" style="margin-top:10px"></div>
            </div>
            <div id="feed"></div>
        </div>
    </div>

    <!-- VIEW 2: EXPLORE (Restored Features) -->
    <div id="view-explore" class="view">
        <div class="header"><h2>Ø§Ø³ØªÙƒØ´Ù</h2></div>
        <div style="padding: 15px;">
            
            <!-- Friend Requests -->
            <div class="card" id="requests-container">
                <h4 style="margin-bottom:10px; color:var(--accent)">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© <span id="req-badge-count" style="background:var(--primary); padding:2px 6px; border-radius:5px; font-size:12px; color:white">0</span></h4>
                <div id="req-list"></div>
                <div class="flex-center" style="gap:10px; margin-top:10px">
                    <input id="friend-email" class="input-box" style="margin:0" placeholder="Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„ØµØ¯ÙŠÙ‚">
                    <button class="btn" onclick="addFriend()"><i class="fas fa-user-plus"></i></button>
                </div>
            </div>

            <!-- Groups & Pages -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px">
                <button class="btn" style="background:#334155" onclick="promptCreate('group')">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
                <button class="btn" style="background:#334155" onclick="promptCreate('page')">Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø©</button>
            </div>

            <h4 style="color:var(--text-sec); margin-bottom:10px">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</h4>
            <div id="groups-list"></div>
            <h4 style="color:var(--text-sec); margin:20px 0 10px">Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø±Ø§Ø¦Ø¬Ø©</h4>
            <div id="pages-list"></div>
        </div>
    </div>

    <!-- VIEW 3: REELS -->
    <div id="view-reels" class="view" style="background: black;">
        <div style="position:absolute; top:20px; left:20px; z-index:100"><button class="btn" style="background:rgba(255,255,255,0.2); backdrop-filter:blur(5px)" onclick="showReelModal()">+ ÙÙŠØ¯ÙŠÙˆ</button></div>
        <div id="reels-container" style="height:100%; overflow-y:scroll; scroll-snap-type:y mandatory"></div>
    </div>

    <!-- VIEW 4: CHAT -->
    <div id="view-chat" class="view">
        <div class="header"><h2>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2></div>
        <div class="chat-tabs flex-between">
            <div class="chat-tab active" onclick="switchChat('global')" id="tab-global">Ø¹Ø§Ù…Ø©</div>
            <div class="chat-tab" onclick="switchChat('private')" id="tab-private">Ø§Ù„Ø®Ø§Øµ</div>
            <div class="chat-tab" onclick="switchChat('ai')" id="tab-ai">AI</div>
        </div>
        
        <!-- Global -->
        <div id="chat-global" style="height:calc(100% - 135px); display:flex; flex-direction:column">
            <div id="g-msgs" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column"></div>
            <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="g-input" class="input-box" style="margin:0" placeholder="Ø§ÙƒØªØ¨..."><button class="btn" onclick="sendGlobal()">â¤</button></div>
        </div>

        <!-- Private -->
        <div id="chat-private" style="height:calc(100% - 135px); display:none; flex-direction:column">
            <div id="friends-list-view" style="padding:15px; flex:1; overflow-y:auto"></div>
            <div id="priv-convo" style="display:none; height:100%; flex-direction:column">
                <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px; align-items:center"><button class="btn" style="padding:5px 10px" onclick="closePriv()">Ø¹ÙˆØ¯Ø©</button> <b id="p-name-header"></b></div>
                <div id="p-msgs" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column"></div>
                <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="p-input" class="input-box" style="margin:0" placeholder="Ø®Ø§Øµ..."><button class="btn" onclick="sendPriv()">â¤</button></div>
            </div>
        </div>

        <!-- AI -->
        <div id="chat-ai" style="height:calc(100% - 135px); display:none; flex-direction:column">
            <div id="ai-msgs" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column"></div>
            <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="ai-input" class="input-box" style="margin:0" placeholder="Ø§Ø³Ø£Ù„ AI..."><button class="btn" onclick="sendAi()">â¤</button></div>
        </div>
    </div>

    <!-- VIEW 5: PROFILE (Dynamic) -->
    <div id="view-profile" class="view">
        <div class="profile-cover">
            <img src="" id="p-avatar" class="profile-pic-lg">
        </div>
        <div style="text-align:center; padding:60px 20px 0">
            <h2 id="p-name"></h2>
            <p id="p-bio" style="color:var(--text-sec); font-size:14px"></p>
            <div id="profile-actions" style="margin-top:15px; display:flex; gap:10px; justify-content:center">
                <!-- Buttons injected via JS -->
            </div>
        </div>
        <div style="padding:20px">
            <h3 style="color:var(--primary); margin-bottom:15px; border-bottom:var(--border); padding-bottom:10px">Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h3>
            <div id="profile-posts"></div>
        </div>
    </div>

    <!-- NAV -->
    <nav class="bottom-nav flex-between">
        <div class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-item" onclick="navTo('explore', this)">
            <i class="fas fa-compass"></i><span>Ø§Ø³ØªÙƒØ´Ù</span>
            <div class="badge" id="nav-req-badge" style="display:none">0</div>
        </div>
        <div class="nav-item" onclick="navTo('reels', this)"><i class="fas fa-play-circle" style="color:var(--accent)"></i><span style="color:var(--accent)">Ø±ÙŠÙ„Ø²</span></div>
        <div class="nav-item" onclick="navTo('chat', this)"><i class="fas fa-comments"></i><span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span></div>
        <div class="nav-item" onclick="openProfile(currentUser.email, this)"><i class="fas fa-user"></i><span>Ù…Ù„ÙÙŠ</span></div>
    </nav>

    <script>
        const socket = io();
        let currentUser = null;
        let isReg = false;
        let currentPriv = null;

        // --- Core Logic ---
        window.onload = () => { const s=localStorage.getItem('u'); if(s) socket.emit('login', JSON.parse(s)); }
        function navTo(v, el) {
            document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            if(el) el.classList.add('active');
        }
        function showLoader(t){ document.getElementById('loader').style.display='flex'; }
        function hideLoader(){ document.getElementById('loader').style.display='none'; }
        function showModal(h){ document.getElementById('modal-content').innerHTML=h; document.getElementById('generic-modal').style.display='flex'; }
        function closeModal(){ document.getElementById('generic-modal').style.display='none'; }

        // --- Auth ---
        function toggleAuth(){ isReg=!isReg; document.getElementById('reg-fields').style.display=isReg?'block':'none'; }
        function auth(){ const e=document.getElementById('email').value, p=document.getElementById('pass').value; if(isReg) socket.emit('register', {name:document.getElementById('reg-name').value, email:e, password:p}); else socket.emit('login', {email:e, password:p}); }
        socket.on('auth_success', (u)=>{ currentUser=u; localStorage.setItem('u', JSON.stringify({email:u.email, password:u.password})); document.getElementById('auth-modal').style.display='none'; updateMyUI(); });
        function updateMyUI(){ document.getElementById('my-avatar').src=currentUser.avatar; document.getElementById('header-avatar').src=currentUser.avatar; }

        // --- Profile System (Universal) ---
        window.openProfile = (email, el) => {
            if(el) navTo('profile', el); else navTo('profile');
            showLoader('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...');
            socket.emit('get_profile_info', email);
        }
        socket.on('open_profile_view', ({user, posts}) => {
            hideLoader();
            document.getElementById('p-avatar').src = user.avatar;
            document.getElementById('p-name').innerText = user.name + (user.isBot ? ' ğŸ¤–' : '');
            document.getElementById('p-bio').innerText = user.bio || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø°Ø©';
            
            const acts = document.getElementById('profile-actions');
            acts.innerHTML = '';
            if(user.email === currentUser.email) {
                acts.innerHTML = `<button class="btn" style="background:rgba(255,255,255,0.1)" onclick="editProfile()">ØªØ¹Ø¯ÙŠÙ„</button>`;
            } else {
                acts.innerHTML = `
                    <button class="btn" onclick="socket.emit('send_friend_request', {from:currentUser.email, to:'${user.email}'}); alert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„')">Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</button>
                    <button class="btn" style="background:var(--secondary)" onclick="startChat('${user.email}', '${user.name}')">Ù…Ø±Ø§Ø³Ù„Ø©</button>
                `;
            }

            const pCont = document.getElementById('profile-posts');
            pCont.innerHTML = '';
            if(posts.length === 0) pCont.innerHTML = '<p style="text-align:center; color:var(--text-sec)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª</p>';
            posts.reverse().forEach(p => renderPost(p, 'profile-posts'));
        });

        function editProfile() { showModal(`<h3>ØªØ¹Ø¯ÙŠÙ„</h3><input id="e-n" class="input-box" value="${currentUser.name}"><button class="btn" onclick="saveP()">Ø­ÙØ¸</button><button class="btn" style="background:none" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>`); }
        function saveP(){ socket.emit('update_profile', {email:currentUser.email, name:document.getElementById('e-n').value}); closeModal(); }
        
        // --- Posts ---
        let postImg=null;
        document.getElementById('post-img').addEventListener('change', function(){ const f=this.files[0]; if(f){const r=new FileReader(); r.onload=(e)=>{postImg=e.target.result; document.getElementById('post-preview').innerHTML=`<img src="${postImg}" style="height:80px;border-radius:10px">`}; r.readAsDataURL(f);} });
        function publishPost(){ const t=document.getElementById('post-txt').value; if(t||postImg){ showLoader('Ù†Ø´Ø±...'); socket.emit('new_post', {content:t, media:postImg, author:currentUser.name, email:currentUser.email, avatar:currentUser.avatar, context:'general', contextId:null}); document.getElementById('post-txt').value=''; postImg=null; document.getElementById('post-preview').innerHTML=''; } }
        socket.on('upload_complete', hideLoader);

        function renderPost(p, target) {
            const l = p.likes.includes(currentUser.email);
            const html = `
            <div class="card">
                <div class="post-header flex-center" style="justify-content:flex-start; gap:10px" onclick="openProfile('${p.email}')">
                    <img src="${p.avatar}" class="avatar">
                    <div><b>${p.author}</b><br><small style="color:var(--text-sec); font-size:11px">${new Date(p.date).toLocaleTimeString()}</small></div>
                </div>
                <p style="margin-top:10px">${p.content||''}</p>
                ${p.media?`<img src="${p.media}" class="post-img">`:''}
                <div class="actions">
                    <div class="act-btn ${l?'liked':''}" onclick="socket.emit('toggle_like',{id:${p.id},type:'post',userEmail:currentUser.email})"><i class="${l?'fas':'far'} fa-heart"></i> <span id="l-${p.id}">${p.likes.length}</span></div>
                    <div class="act-btn" onclick="toggleC(${p.id})"><i class="far fa-comment"></i> <span>${p.comments.length}</span></div>
                </div>
                <div class="comments-section" id="com-${p.id}">
                    <div id="clist-${p.id}">${p.comments.map(c=>`<div class="comment-item"><img src="${c.userAvatar}" class="avatar" style="width:25px;height:25px"><div class="comment-bubble" onclick="openProfile('${c.userEmail}')"><b>${c.userName}</b><br>${c.text}</div></div>`).join('')}</div>
                    <div style="display:flex; gap:5px; margin-top:10px"><input id="cin-${p.id}" class="input-box" style="padding:8px" placeholder="ØªØ¹Ù„ÙŠÙ‚.."><button class="btn" style="padding:5px 10px" onclick="sendC(${p.id})">â¤</button></div>
                </div>
            </div>`;
            document.getElementById(target).insertAdjacentHTML('afterbegin', html);
        }
        window.toggleC=(id)=>{const e=document.getElementById(`com-${id}`); e.style.display=e.style.display==='block'?'none':'block';}
        window.sendC=(id)=>{const t=document.getElementById(`cin-${id}`).value; if(t){socket.emit('add_comment',{postId:id, text:t, userEmail:currentUser.email, userName:currentUser.name, userAvatar:currentUser.avatar}); document.getElementById(`cin-${id}`).value='';}}
        socket.on('update_comments', (d)=>{ document.getElementById(`clist-${d.postId}`).innerHTML = d.comments.map(c=>`<div class="comment-item"><img src="${c.userAvatar}" class="avatar" style="width:25px;height:25px"><div class="comment-bubble"><b>${c.userName}</b><br>${c.text}</div></div>`).join(''); });
        socket.on('update_likes', (d)=>{ const e=document.getElementById(`l-${d.id}`); if(e)e.innerText=d.likes.length; });
        socket.on('receive_post', (p)=>renderPost(p,'feed'));
        socket.on('load_posts', (ps)=>{ document.getElementById('feed').innerHTML=''; ps.reverse().forEach(p=>renderPost(p,'feed')); });

        // --- Explore (Requests, Groups, Pages) ---
        socket.on('update_requests', (reqs) => {
            document.getElementById('req-badge-count').innerText = reqs.length;
            document.getElementById('nav-req-badge').style.display = reqs.length?'block':'none';
            document.getElementById('req-list').innerHTML = reqs.map(r => `
                <div class="card flex-between" style="padding:10px; margin-bottom:5px">
                    <div class="flex-center" style="gap:10px"><img src="${r.avatar}" class="avatar" style="width:35px;height:35px"> <span>${r.name}</span></div>
                    <button class="btn" style="padding:5px 10px; font-size:12px" onclick="socket.emit('respond_friend_request',{userEmail:currentUser.email, requesterEmail:'${r.email}', accept:true})">Ù‚Ø¨ÙˆÙ„</button>
                </div>
            `).join('');
        });
        function addFriend(){ socket.emit('send_friend_request', {from:currentUser.email, to:document.getElementById('friend-email').value}); document.getElementById('friend-email').value=''; alert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); }
        function promptCreate(t){ const n=prompt('Ø§Ù„Ø§Ø³Ù…:'); if(n) t==='group'?socket.emit('create_group',{name:n,desc:'',owner:currentUser.email}):socket.emit('create_page',{name:n,owner:currentUser.email}); }
        socket.on('init_data', (d)=>{
            document.getElementById('groups-list').innerHTML = d.groups.map(g=>`<div class="card flex-between" style="padding:10px"><b>${g.name}</b> <button class="btn" style="font-size:10px;padding:5px">Ø¯Ø®ÙˆÙ„</button></div>`).join('');
            document.getElementById('pages-list').innerHTML = d.pages.map(p=>`<div class="card flex-between" style="padding:10px"><b>${p.name}</b> <button class="btn" style="font-size:10px;padding:5px;background:var(--secondary)">Ù…ØªØ§Ø¨Ø¹Ø©</button></div>`).join('');
            d.reels.forEach(r => {
                document.getElementById('reels-container').insertAdjacentHTML('beforeend', `<div class="reel-item" style="height:calc(100vh - 75px); background:black; display:flex; justify-content:center; border-bottom:1px solid #333; scroll-snap-align:start"><video src="${r.url}" controls style="width:100%; height:100%"></video></div>`);
            });
        });

        // --- Chat ---
        function switchChat(t) { ['global','private','ai'].forEach(x=>document.getElementById(`chat-${x}`).style.display=x===t?'flex':'none'); document.querySelectorAll('.chat-tab').forEach(x=>x.classList.remove('active')); document.getElementById(`tab-${t}`).classList.add('active'); }
        function sendGlobal(){ const t=document.getElementById('g-input').value; if(t){ socket.emit('send_global_msg',{text:t,author:currentUser.name,email:currentUser.email,avatar:currentUser.avatar}); document.getElementById('g-input').value=''; } }
        socket.on('receive_global_msg', (m)=>{ 
            const me=m.email===currentUser.email; 
            document.getElementById('g-msgs').innerHTML+=`<div style="display:flex;flex-direction:column;align-items:${me?'flex-start':'flex-end'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}" onclick="openProfile('${m.email}')"><b>${me?'':m.author+':'}</b> ${m.text}</div></div>`; 
        });
        function sendAi(){ const t=document.getElementById('ai-input').value; if(t){ document.getElementById('ai-msgs').innerHTML+=`<div class="msg-bubble msg-me">${t}</div>`; socket.emit('send_ai_msg',t); document.getElementById('ai-input').value=''; } }
        socket.on('receive_ai_msg', (m)=>{ document.getElementById('ai-msgs').innerHTML+=`<div class="msg-bubble msg-other">${m.text}</div>`; });

        // Private
        socket.on('update_friends', (f) => {
            document.getElementById('friends-list-view').innerHTML = f.map(u => `<div class="friend-item" style="padding:10px; background:rgba(255,255,255,0.05); margin-bottom:5px; border-radius:10px; cursor:pointer; display:flex; gap:10px; align-items:center" onclick="startChat('${u.email}', '${u.name}')"><img src="${u.avatar}" class="avatar"> ${u.name}</div>`).join('');
        });
        window.startChat = (e, n) => { currentPriv=e; navTo('chat'); switchChat('private'); document.getElementById('friends-list-view').style.display='none'; document.getElementById('priv-convo').style.display='flex'; document.getElementById('p-name-header').innerText=n; document.getElementById('p-msgs').innerHTML=''; socket.emit('get_private_msgs',{u1:currentUser.email, u2:e}); }
        function closePriv(){ document.getElementById('priv-convo').style.display='none'; document.getElementById('friends-list-view').style.display='block'; currentPriv=null; }
        function sendPriv(){ const t=document.getElementById('p-input').value; if(t){ socket.emit('send_private_msg',{from:currentUser.email, to:currentPriv, text:t}); document.getElementById('p-input').value=''; } }
        socket.on('load_private_msgs', (ms)=>{ document.getElementById('p-msgs').innerHTML = ms.map(m=>`<div class="msg-bubble ${m.from===currentUser.email?'msg-me':'msg-other'}">${m.text}</div>`).join(''); });
        socket.on('receive_private_msg', (m)=>{ if(m.from===currentPriv || m.from===currentUser.email) document.getElementById('p-msgs').innerHTML+=`<div class="msg-bubble ${m.from===currentUser.email?'msg-me':'msg-other'}">${m.text}</div>`; });

        // Reels
        function showReelModal(){ showModal(`<h3>ÙÙŠØ¯ÙŠÙˆ</h3><input type="file" id="r-f" class="input-box" accept="video/*"><input id="r-d" class="input-box" placeholder="ÙˆØµÙ"><button class="btn" style="width:100%" onclick="uplR()">Ù†Ø´Ø±</button><button class="btn" style="width:100%;background:none" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>`); }
        async function uplR(){ const f=document.getElementById('r-f').files[0], d=document.getElementById('r-d').value; if(!f)return; showLoader('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...'); socket.emit('new_reel', {videoBase64:await toBase64(f), desc:d, author:currentUser.name, avatar:currentUser.avatar, email:currentUser.email}); }
        const toBase64=f=>new Promise((r,j)=>{const rd=new FileReader();rd.readAsDataURL(f);rd.onload=()=>r(rd.result);rd.onerror=e=>j(e);});
        socket.on('receive_reel', (r)=>{ document.getElementById('reels-container').insertAdjacentHTML('afterbegin', `<div class="reel-item" style="height:calc(100vh - 75px); background:black; display:flex; justify-content:center; border-bottom:1px solid #333; scroll-snap-align:start"><video src="${r.url}" controls style="width:100%; height:100%"></video></div>`); });

    </script>
</body>
                </html>
