<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blogane Ultra</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-deep: #000000;
            --panel-bg: #1e1e1e;
            --primary: #ff0000; /* YouTube Red */
            --text: #ffffff;
            --text-gray: #aaaaaa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg-deep); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* UI Elements */
        .btn { 
            background: #cc0000; color: white; border: none; padding: 8px 16px; border-radius: 20px;
            cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        
        .card {
            background: var(--panel-bg); border-radius: 12px; padding: 15px; margin-bottom: 10px;
        }

        .input-box { 
            width: 100%; background: #333; border: none; padding: 12px; border-radius: 8px; color: white; outline: none; margin-bottom: 10px;
        }

        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        /* Nav */
        .bottom-nav { 
            height: 60px; background: #0f0f0f; border-top: 1px solid #333;
            display: flex; justify-content: space-around; align-items: center; 
            position: fixed; bottom: 0; width: 100%; z-index: 500; 
        }
        .nav-item { color: white; font-size: 22px; text-align: center; cursor: pointer; opacity: 0.6; }
        .nav-item.active { opacity: 1; }
        .nav-item span { font-size: 10px; display: block; }

        .view { display: none; height: 100%; overflow-y: auto; padding-bottom: 80px; }
        .view.active { display: block; }

        .header { padding: 15px; background: rgba(15,15,15,0.9); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }

        /* Reels (YouTube Shorts Style) */
        .reel-item { 
            height: calc(100vh - 60px); /* Full height minus nav */
            background: black; position: relative; 
            scroll-snap-align: start; display: flex; justify-content: center;
        }
        .reel-video { width: 100%; height: 100%; object-fit: cover; }
        
        /* UI Overlay for Reels */
        .reel-ui-right {
            position: absolute; bottom: 100px; left: 10px; /* Left because RTL */
            display: flex; flex-direction: column; gap: 25px; align-items: center; z-index: 10;
        }
        .reel-action { display: flex; flex-direction: column; align-items: center; gap: 5px; text-shadow: 1px 1px 2px black; }
        .reel-action i { font-size: 28px; cursor: pointer; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 50%; }
        .reel-action span { font-size: 12px; font-weight: bold; }

        .reel-ui-bottom {
            position: absolute; bottom: 20px; right: 10px; /* Right because RTL */
            width: 75%; z-index: 10; text-shadow: 1px 1px 2px black;
            pointer-events: none;
        }
        .reel-user { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; pointer-events: auto; }
        .reel-desc { font-size: 14px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Modals & Loaders */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #222; width: 90%; max-width: 400px; padding: 25px; border-radius: 15px; }
        .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #555; border-top: 4px solid #cc0000; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .post-img { width: 100%; border-radius: 10px; margin-top: 10px; }
        
        /* Chat */
        .msg-bubble { padding: 10px 15px; border-radius: 15px; max-width: 80%; margin-bottom: 8px; font-size: 14px; }
        .msg-me { background: #3ea6ff; color: black; align-self: flex-start; }
        .msg-other { background: #333; align-self: flex-end; }
    </style>
</head>
<body>

    <div class="loader-overlay" id="loader">
        <div class="spinner"></div><p style="margin-top:15px" id="loader-text">...</p>
    </div>

    <!-- Auth -->
    <div class="modal-overlay" id="auth-modal" style="display: flex;">
        <div class="modal-box" style="text-align: center;">
            <h1 style="color: #ff0000;">Blogane</h1>
            <div id="reg-fields" style="display: none;"><input type="text" id="reg-name" class="input-box" placeholder="الاسم"></div>
            <input type="email" id="email" class="input-box" placeholder="البريد">
            <input type="password" id="pass" class="input-box" placeholder="المرور">
            <button class="btn" style="width:100%" onclick="auth()">دخول</button>
            <p style="margin-top:15px;color:#aaa;cursor:pointer" onclick="toggleAuth()">حساب جديد؟</p>
        </div>
    </div>

    <!-- Generic Modal -->
    <div class="modal-overlay" id="generic-modal"><div class="modal-box" id="modal-content"></div></div>

    <!-- 1. HOME -->
    <div id="view-home" class="view active">
        <div class="header">
            <h3>الرئيسية</h3><img src="" id="header-avatar" class="avatar" onclick="navTo('profile')">
        </div>
        <div id="ctx-banner" style="display:none; padding:15px; background:#333; text-align:center; position:relative">
            <h3 id="ctx-title"></h3>
            <!-- Delete Button (Hidden by default) -->
            <button id="delete-context-btn" class="btn" style="background:#cc0000; margin-top:10px; display:none; font-size:12px" onclick="deleteCurrentContext()">حذف المجموعة/الصفحة</button>
            <button class="btn" style="background:#555; margin-top:10px; font-size:12px" onclick="leaveContext()">خروج للعامة</button>
        </div>
        <div style="padding: 10px;">
            <div class="card">
                <div style="display: flex; gap: 10px;"><img src="" id="my-avatar" class="avatar"><input type="text" id="post-txt" class="input-box" style="margin:0; border-radius:20px" placeholder="أضف منشوراً..."></div>
                <div style="display:flex; justify-content:space-between; margin-top:10px">
                    <label style="color:#3ea6ff; cursor:pointer"><i class="fas fa-image"></i> صورة<input type="file" id="post-img" hidden></label>
                    <button class="btn" style="padding:5px 15px" onclick="publishPost()">نشر</button>
                </div>
            </div>
            <div id="feed"></div>
        </div>
    </div>

    <!-- 2. EXPLORE -->
    <div id="view-explore" class="view">
        <div class="header"><h3>استكشف</h3></div>
        <div style="padding: 10px;">
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <button class="btn" onclick="promptCreate('group')">مجموعة +</button>
                <button class="btn" style="background:#3ea6ff; color:black" onclick="promptCreate('page')">صفحة +</button>
            </div>
            <h4 style="color:#aaa">المجموعات</h4><div id="groups-list"></div>
            <h4 style="color:#aaa; margin-top:15px">الصفحات</h4><div id="pages-list"></div>
        </div>
    </div>

    <!-- 3. REELS (YouTube Shorts Style) -->
    <div id="view-reels" class="view" style="background: black; padding-bottom: 60px;">
        <div style="position:absolute; top:20px; left:20px; z-index:100"><button class="btn" style="background:rgba(255,255,255,0.2)" onclick="showReelModal()"><i class="fas fa-camera"></i></button></div>
        <div id="reels-container" style="height:100%; overflow-y:scroll; scroll-snap-type:y mandatory"></div>
    </div>

    <!-- 4. CHAT -->
    <div id="view-chat" class="view">
        <div class="header"><h3>الدردشة</h3></div>
        <div style="display:flex; padding:10px; gap:10px">
            <button class="btn" style="flex:1; background:#333" onclick="switchChat('global')">عامة</button>
            <button class="btn" style="flex:1; background:#333" onclick="switchChat('ai')">مساعد AI</button>
        </div>
        <div id="chat-global" style="height:calc(100% - 120px); display:flex; flex-direction:column;">
            <div id="g-msgs" style="flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column"></div>
            <div style="padding:10px; display:flex; gap:5px"><input id="g-input" class="input-box" style="margin:0"><button class="btn" onclick="sendGlobal()">➤</button></div>
        </div>
        <div id="chat-ai" style="height:calc(100% - 120px); display:none; flex-direction:column;">
            <div id="ai-msgs" style="flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column"></div>
            <div style="padding:10px; display:flex; gap:5px"><input id="ai-input" class="input-box" style="margin:0"><button class="btn" onclick="sendAi()">➤</button></div>
        </div>
    </div>

    <!-- 5. PROFILE -->
    <div id="view-profile" class="view">
        <div style="padding:20px; text-align:center">
            <img src="" id="p-avatar" class="avatar" style="width:80px; height:80px">
            <h2 id="p-name" style="margin-top:10px"></h2>
            <button class="btn" style="background:#333; margin-top:10px; font-size:12px" onclick="showEditProfile()">تعديل</button>
        </div>
        <div id="profile-posts" style="padding:10px"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i><span>الرئيسية</span></div>
        <div class="nav-item" onclick="navTo('explore', this)"><i class="fas fa-compass"></i><span>استكشف</span></div>
        <div class="nav-item" onclick="navTo('reels', this)"><i class="fas fa-play-circle"></i><span>شورتس</span></div>
        <div class="nav-item" onclick="navTo('chat', this)"><i class="fas fa-comment-alt"></i><span>شات</span></div>
        <div class="nav-item" onclick="navTo('profile', this)"><i class="fas fa-user"></i><span>أنا</span></div>
    </nav>

    <script>
        const socket = io();
        let currentUser = null;
        let currentContext = 'general'; // 'group', 'page'
        let currentContextId = null;
        let currentContextOwner = null;
        let isReg = false;

        // --- Auto Login ---
        window.onload = () => {
            const savedUser = localStorage.getItem('blogane_user');
            if(savedUser) {
                const creds = JSON.parse(savedUser);
                socket.emit('login', creds);
            }
        };

        function showLoader(t) { document.getElementById('loader-text').innerText=t; document.getElementById('loader').style.display='flex'; }
        function hideLoader() { document.getElementById('loader').style.display='none'; }
        function showModal(h) { document.getElementById('modal-content').innerHTML=h; document.getElementById('generic-modal').style.display='flex'; }
        function closeModal() { document.getElementById('generic-modal').style.display='none'; }

        function navTo(v, el) {
            document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            if(el) el.classList.add('active'); else if(v==='profile') document.querySelector('.nav-item:last-child').classList.add('active');
            if(v==='profile') socket.emit('get_user_posts', currentUser.email);
        }

        // --- Auth ---
        function toggleAuth(){ isReg=!isReg; document.getElementById('reg-fields').style.display=isReg?'block':'none'; }
        function auth() {
            const email=document.getElementById('email').value, pass=document.getElementById('pass').value;
            if(email && pass) {
                if(isReg) socket.emit('register', { name:document.getElementById('reg-name').value, email, password:pass });
                else socket.emit('login', { email, password:pass });
            }
        }
        socket.on('auth_success', (u) => {
            currentUser = u; 
            localStorage.setItem('blogane_user', JSON.stringify({email:u.email, password:u.password})); // Save Login
            document.getElementById('auth-modal').style.display='none'; 
            updateUI(); 
        });
        function updateUI(){
            document.getElementById('my-avatar').src=currentUser.avatar;
            document.getElementById('header-avatar').src=currentUser.avatar;
            document.getElementById('p-avatar').src=currentUser.avatar;
            document.getElementById('p-name').innerText=currentUser.name;
        }

        // --- Reels (YouTube Shorts Style) ---
        function showReelModal(){ showModal(`<h3>نشر فيديو قصير</h3><input type="file" id="reel-file" class="input-box" accept="video/*"><input type="text" id="reel-desc" class="input-box" placeholder="اكتب وصفاً"><button class="btn" style="width:100%" onclick="upReel()">نشر</button><button class="btn" style="width:100%;background:none;margin-top:5px" onclick="closeModal()">إلغاء</button>`); }
        async function upReel(){
            const f=document.getElementById('reel-file').files[0], d=document.getElementById('reel-desc').value; if(!f)return;
            showLoader('جاري الرفع...');
            socket.emit('upload_reel_start', {name:f.name});
            const CHUNK=500*1024, total=Math.ceil(f.size/CHUNK);
            socket.once('upload_ready', async ({tempFileName}) => {
                for(let i=0; i<total; i++){
                    socket.emit('upload_reel_chunk', {fileName:tempFileName, data:await f.slice(i*CHUNK,(i+1)*CHUNK).arrayBuffer()});
                }
                socket.emit('upload_reel_end', {fileName:tempFileName, desc:d, author:currentUser.name, avatar:currentUser.avatar, email:currentUser.email});
            });
        }
        socket.on('upload_complete', () => { hideLoader(); closeModal(); });
        
        socket.on('receive_reel', (r) => renderReel(r, true)); // true = prepend
        function renderReel(r, prepend) {
            const l = r.likes.includes(currentUser.email);
            const html = `
            <div class="reel-item">
                <video src="${r.url}" class="reel-video" loop onclick="this.paused?this.play():this.pause()"></video>
                <div class="reel-ui-right">
                    <div class="reel-action" onclick="socket.emit('toggle_like',{id:${r.id},type:'reel',userEmail:currentUser.email})"><i class="${l?'fas':'far'} fa-heart" style="color:${l?'red':'white'}"></i><span id="rl-${r.id}">${r.likes.length}</span></div>
                    <div class="reel-action"><i class="fas fa-comment-dots"></i><span>${r.comments.length}</span></div>
                    <div class="reel-action"><i class="fas fa-share"></i><span>Share</span></div>
                </div>
                <div class="reel-ui-bottom">
                    <div class="reel-user"><img src="${r.avatar}" class="avatar" style="border:1px solid white"><b>${r.author}</b><button class="btn" style="padding:4px 10px;font-size:10px;background:red">اشتراك</button></div>
                    <div class="reel-desc">${r.desc}</div>
                </div>
            </div>`;
            const c = document.getElementById('reels-container');
            prepend ? c.insertAdjacentHTML('afterbegin', html) : c.insertAdjacentHTML('beforeend', html);
        }

        // --- Posts ---
        let postImg=null;
        document.getElementById('post-img').addEventListener('change', function(){ const f=this.files[0]; if(f){const r=new FileReader(); r.onload=(e)=>{postImg=e.target.result;}; r.readAsDataURL(f);} });
        function publishPost(){ 
            const t=document.getElementById('post-txt').value; if(!t&&!postImg)return;
            showLoader('نشر...');
            socket.emit('new_post', {content:t, media:postImg, author:currentUser.name, email:currentUser.email, avatar:currentUser.avatar, context:currentContext, contextId:currentContextId});
            document.getElementById('post-txt').value=''; postImg=null;
        }
        function renderPost(p, target) {
            const l = p.likes.includes(currentUser.email);
            const html = `<div class="card"><div style="display:flex;gap:10px"><img src="${p.avatar}" class="avatar"><div><b>${p.author}</b><br><small style="color:#aaa">${new Date(p.date).toLocaleTimeString()}</small></div></div><p style="margin-top:10px">${p.content||''}</p>${p.media?`<img src="${p.media}" style="width:100%;border-radius:10px;margin-top:10px">`:''}<div style="margin-top:15px;display:flex;gap:20px"><i class="${l?'fas':'far'} fa-heart" style="color:${l?'red':'#aaa'}" onclick="socket.emit('toggle_like',{id:${p.id},type:'post',userEmail:currentUser.email})"> <span id="l-${p.id}" style="color:#aaa">${p.likes.length}</span></i></div></div>`;
            document.getElementById(target).insertAdjacentHTML('afterbegin', html);
        }
        socket.on('receive_post', (p) => { if(p.context===currentContext && p.contextId===currentContextId) renderPost(p,'feed'); });
        socket.on('load_posts', (ps) => { document.getElementById('feed').innerHTML=''; ps.reverse().forEach(p=>renderPost(p,'feed')); });
        socket.on('load_profile_posts', (ps) => { document.getElementById('profile-posts').innerHTML=''; ps.reverse().forEach(p=>renderPost(p,'profile-posts')); });
        socket.on('update_likes', (d) => { const e=document.getElementById((d.type==='reel'?'rl-':'l-')+d.id); if(e)e.innerText=d.likes.length; });

        // --- Context & Deletion ---
        function enterContext(t,i,n,owner) {
            currentContext=t; currentContextId=i; currentContextOwner=owner;
            navTo('home');
            document.getElementById('ctx-banner').style.display='block';
            document.getElementById('ctx-title').innerText=n;
            
            // Show Delete Button only if owner
            const delBtn = document.getElementById('delete-context-btn');
            if(currentUser.email === owner) {
                delBtn.style.display = 'inline-block';
            } else {
                delBtn.style.display = 'none';
            }

            document.getElementById('feed').innerHTML='';
            socket.emit('get_context_posts', {context:t, contextId:i});
        }

        function leaveContext(){
            currentContext='general'; currentContextId=null; currentContextOwner=null;
            document.getElementById('ctx-banner').style.display='none';
            document.getElementById('feed').innerHTML='';
            socket.emit('get_context_posts', {context:'general', contextId:null});
        }

        function deleteCurrentContext() {
            if(confirm('هل أنت متأكد من الحذف؟ لا يمكن التراجع.')) {
                if(currentContext === 'group') socket.emit('delete_group', {groupId: currentContextId, email: currentUser.email});
                else if(currentContext === 'page') socket.emit('delete_page', {pageId: currentContextId, email: currentUser.email});
            }
        }

        socket.on('delete_success', () => {
            alert('تم الحذف بنجاح');
            leaveContext();
        });

        // --- Init & Lists ---
        socket.on('init_data', (d) => {
            d.reels.forEach(r => renderReel(r, false));
            updateLists(d.groups, d.pages);
        });
        socket.on('update_groups', (g) => updateLists(g, null));
        socket.on('update_pages', (p) => updateLists(null, p));

        function updateLists(groups, pages) {
            if(groups) document.getElementById('groups-list').innerHTML = groups.map(g=>`<div class="card" onclick="enterContext('group','${g.id}','${g.name}','${g.owner}')"><b>${g.name}</b></div>`).join('');
            if(pages) document.getElementById('pages-list').innerHTML = pages.map(p=>`<div class="card" onclick="enterContext('page','${p.id}','${p.name}','${p.owner}')"><b>${p.name}</b></div>`).join('');
        }

        // --- Chat ---
        function switchChat(t){ document.getElementById('chat-global').style.display=t==='g'?'flex':'none'; document.getElementById('chat-ai').style.display=t==='ai'?'flex':'none'; }
        function sendGlobal(){ const t=document.getElementById('g-input').value; if(t){socket.emit('send_global_msg',{text:t,author:currentUser.name,email:currentUser.email,avatar:currentUser.avatar});document.getElementById('g-input').value='';} }
        socket.on('receive_global_msg', (m)=>{ document.getElementById('g-msgs').innerHTML+=`<div style="text-align:${m.email===currentUser.email?'left':'right'}"><div class="msg-bubble ${m.email===currentUser.email?'msg-me':'msg-other'}"><b>${m.author}</b>: ${m.text}</div></div>`; });
        function sendAi(){ const t=document.getElementById('ai-input').value; if(t){ document.getElementById('ai-msgs').innerHTML+=`<div class="msg-bubble msg-me">${t}</div>`; socket.emit('send_ai_msg', t); document.getElementById('ai-input').value=''; } }
        socket.on('receive_ai_msg', (m)=>{ document.getElementById('ai-msgs').innerHTML+=`<div class="msg-bubble msg-other">${m.text}</div>`; });

        // Misc
        function promptCreate(t){ const n=prompt('الاسم:'); if(n) t==='group'?socket.emit('create_group',{name:n,desc:'',owner:currentUser.email}):socket.emit('create_page',{name:n,owner:currentUser.email}); }
        function showEditProfile(){ showModal(`<h3>تعديل</h3><input id="e-n" class="input-box" value="${currentUser.name}"><button class="btn" onclick="saveProf()">حفظ</button><button class="btn" style="background:none" onclick="closeModal()">إلغاء</button>`); }
        function saveProf(){ socket.emit('update_profile',{email:currentUser.email, name:document.getElementById('e-n').value}); closeModal(); }
        socket.on('profile_updated_success', (u)=>{ currentUser=u; updateUI(); });
    </script>
</body>
    </html>
