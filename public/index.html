<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blogane Gold</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #09090b; --panel: rgba(30, 41, 59, 0.85); --primary: #8b5cf6; --accent: #ec4899; --gold: #fbbf24; --text: #f8fafc; --glass: blur(16px); --border: 1px solid rgba(255, 255, 255, 0.1); }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); background-image: radial-gradient(circle at top, #312e81 0%, transparent 50%); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .btn { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; padding: 8px 16px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .card { background: var(--panel); backdrop-filter: var(--glass); border: var(--border); border-radius: 18px; padding: 15px; margin-bottom: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .input-box { width: 100%; background: rgba(0,0,0,0.3); border: var(--border); padding: 12px; border-radius: 12px; color: white; outline: none; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }

        /* Toast Notification */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(16, 185, 129, 0.9); color: white; padding: 12px 20px; border-radius: 25px; z-index: 2000; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; width: 90%; max-width: 300px; }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Coins Badge */
        .coins-badge { background: rgba(251, 191, 36, 0.2); color: var(--gold); padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; border: 1px solid var(--gold); display: flex; align-items: center; gap: 5px; }

        /* Gift Message */
        .gift-msg { background: linear-gradient(45deg, #f59e0b, #d97706); color: white; text-align: center; border: 2px solid #fbbf24; }
        .gift-icon { font-size: 40px; display: block; margin: 5px 0; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Gift Modal Grid */
        .gift-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .gift-item { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .gift-item:hover { border-color: var(--gold); background: rgba(251, 191, 36, 0.1); }

        /* Bottom Nav */
        .bottom-nav { height: 70px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; width: 100%; z-index: 500; border-top: var(--border); }
        .nav-item { color: var(--gray); font-size: 22px; cursor: pointer; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .badge-dot { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; display: none; }

        /* Generic */
        .view { display: none; height: 100%; overflow-y: auto; padding-bottom: 90px; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .header { padding: 15px 20px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: var(--border); }
        
        /* Chat */
        .chat-tabs { display: flex; gap: 10px; padding: 10px; }
        .chat-tab { flex: 1; text-align: center; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.05); color: var(--gray); cursor: pointer; }
        .chat-tab.active { background: var(--primary); color: white; }
        .msg-bubble { padding: 10px 15px; border-radius: 18px; max-width: 75%; margin-bottom: 8px; font-size: 14px; }
        .msg-me { background: var(--primary); align-self: flex-start; }
        .msg-other { background: #334155; align-self: flex-end; }

        /* Loader & Modal */
        .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #1e293b; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; border: var(--border); }
    </style>
</head>
<body>

    <!-- Sounds -->
    <audio id="snd-msg" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="snd-notif" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <audio id="snd-coin" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

    <!-- Notification Toast -->
    <div id="toast" class="toast">
        <i class="fas fa-bell"></i>
        <span id="toast-msg">Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯</span>
    </div>

    <div class="loader-overlay" id="loader"><div class="spinner"></div><p style="margin-top:15px; color:white">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>

    <!-- Auth -->
    <div id="auth-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box" style="text-align: center;">
            <h1 style="font-size:35px; color:var(--primary); margin-bottom:10px">Blogane</h1>
            <div id="reg-fields" style="display:none"><input id="reg-name" class="input-box" placeholder="Ø§Ù„Ø§Ø³Ù…" style="margin-bottom:10px"></div>
            <input id="email" class="input-box" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="margin-bottom:10px">
            <input id="pass" type="password" class="input-box" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom:15px">
            <button class="btn" style="width:100%" onclick="auth()">Ø¯Ø®ÙˆÙ„</button>
            <p style="margin-top:20px; cursor:pointer; color:var(--gray)" onclick="toggleAuth()">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ</p>
        </div>
    </div>

    <!-- Gift Modal -->
    <div id="gift-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <h3 style="text-align:center; color:var(--gold)">Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© ğŸ</h3>
            <p style="text-align:center; font-size:12px; color:var(--gray)">Ø±ØµÙŠØ¯Ùƒ: <span id="gift-balance">0</span></p>
            <div class="gift-grid">
                <div class="gift-item" onclick="sendGift('ÙˆØ±Ø¯Ø©', 10, 'ğŸŒ¹')"><span style="font-size:30px">ğŸŒ¹</span><br>10 ğŸŸ¡</div>
                <div class="gift-item" onclick="sendGift('Ù‚Ù‡ÙˆØ©', 20, 'â˜•')"><span style="font-size:30px">â˜•</span><br>20 ğŸŸ¡</div>
                <div class="gift-item" onclick="sendGift('Ù‚Ù„Ø¨', 30, 'â¤ï¸')"><span style="font-size:30px">â¤ï¸</span><br>30 ğŸŸ¡</div>
                <div class="gift-item" onclick="sendGift('Ø¬ÙˆÙ‡Ø±Ø©', 50, 'ğŸ’')"><span style="font-size:30px">ğŸ’</span><br>50 ğŸŸ¡</div>
                <div class="gift-item" onclick="sendGift('ØªØ§Ø¬', 100, 'ğŸ‘‘')"><span style="font-size:30px">ğŸ‘‘</span><br>100 ğŸŸ¡</div>
                <div class="gift-item" onclick="sendGift('Ø³ÙŠØ§Ø±Ø©', 500, 'ğŸï¸')"><span style="font-size:30px">ğŸï¸</span><br>500 ğŸŸ¡</div>
            </div>
            <button class="btn" style="width:100%; background:#333; margin-top:15px" onclick="document.getElementById('gift-modal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal-overlay" id="generic-modal"><div class="modal-box" id="modal-content"></div></div>

    <!-- HOME -->
    <div id="view-home" class="view active">
        <div class="header">
            <div class="coins-badge"><i class="fas fa-coins"></i> <span id="user-coins">0</span></div>
            <img src="" id="header-avatar" class="avatar" onclick="openProfile(currentUser.email)">
        </div>
        <div style="padding: 15px;">
            <div class="card">
                <div style="display:flex; gap:10px"><img src="" id="my-avatar" class="avatar"><input id="post-txt" class="input-box" style="border-radius:25px; border:none; background:rgba(255,255,255,0.05)" placeholder="Ø¨Ù…Ø§Ø°Ø§ ØªÙÙƒØ±ØŸ"></div>
                <div style="display:flex; justify-content:space-between; margin-top:15px">
                    <label style="color:#10b981; cursor:pointer; display:flex; align-items:center; gap:5px"><i class="fas fa-image"></i> ØµÙˆØ±Ø©<input type="file" id="post-img" hidden></label>
                    <button class="btn" onclick="publishPost()">Ù†Ø´Ø±</button>
                </div>
            </div>
            <div id="feed"></div>
        </div>
    </div>

    <!-- CHAT -->
    <div id="view-chat" class="view">
        <div class="header"><h2>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2></div>
        <div class="chat-tabs">
            <div class="chat-tab active" onclick="switchChat('global')" id="tab-global">Ø¹Ø§Ù…Ø©</div>
            <div class="chat-tab" onclick="switchChat('private')" id="tab-private">Ø§Ù„Ø®Ø§Øµ</div>
        </div>
        
        <div id="chat-global" style="height:calc(100% - 120px); display:flex; flex-direction:column">
            <div id="g-msgs" style="flex:1; overflow-y:auto; padding:15px"></div>
            <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="g-input" class="input-box" style="margin:0" placeholder="Ø§ÙƒØªØ¨..."><button class="btn" onclick="sendGlobal()">â¤</button></div>
        </div>

        <div id="chat-private" style="height:calc(100% - 120px); display:none; flex-direction:column">
            <div id="friends-list-view" style="padding:15px; flex:1; overflow-y:auto"></div>
            <div id="priv-convo" style="display:none; height:100%; flex-direction:column">
                <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px; align-items:center; justify-content:space-between">
                    <div style="display:flex; gap:10px; align-items:center"><button class="btn" style="padding:5px 10px" onclick="closePriv()">âœ</button> <b id="p-name-header"></b></div>
                    <button class="btn" style="background:var(--gold); color:black" onclick="showGifts()">ğŸ</button>
                </div>
                <div id="p-msgs" style="flex:1; overflow-y:auto; padding:15px"></div>
                <div style="padding:10px; background:rgba(0,0,0,0.3); display:flex; gap:10px"><input id="p-input" class="input-box" style="margin:0" placeholder="Ø®Ø§Øµ..."><button class="btn" onclick="sendPriv()">â¤</button></div>
            </div>
        </div>
    </div>

    <!-- (Explore, Reels, Profile - Simplified for length, but included in logic) -->
    <div id="view-explore" class="view"><div class="header"><h2>Ø§Ø³ØªÙƒØ´Ù</h2></div><div style="padding:15px" id="explore-content"></div></div>
    <div id="view-reels" class="view" style="background:black"><div id="reels-container"></div></div>
    <div id="view-profile" class="view"><div id="profile-content"></div></div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i></div>
        <div class="nav-item" onclick="navTo('explore', this)"><i class="fas fa-compass"></i></div>
        <div class="nav-item" onclick="navTo('reels', this)"><i class="fas fa-play-circle" style="color:var(--accent)"></i></div>
        <div class="nav-item" onclick="navTo('chat', this)"><i class="fas fa-comments"></i><span class="badge-dot" id="msg-badge"></span></div>
        <div class="nav-item" onclick="openProfile(currentUser.email, this)"><i class="fas fa-user"></i></div>
    </nav>

    <script>
        const socket = io();
        let currentUser = null, currentPriv = null, isReg = false;

        // --- Sounds & Notify ---
        const sndMsg = document.getElementById('snd-msg');
        const sndNotif = document.getElementById('snd-notif');
        const sndCoin = document.getElementById('snd-coin');

        function notify(title, body) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerHTML = `<b>${title}</b><br>${body}`;
            t.classList.add('show');
            sndNotif.play().catch(()=>{});
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- Auto Login ---
        window.onload = () => { 
            const s=localStorage.getItem('u'); 
            if(s) socket.emit('login', JSON.parse(s)); 
            else { hideLoader(); document.getElementById('auth-modal').style.display='flex'; }
        }

        function navTo(v, el) {
            document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            if(el) el.classList.add('active');
            if(v==='chat') document.getElementById('msg-badge').style.display='none';
        }
        function showLoader(t){ document.getElementById('loader').style.display='flex'; }
        function hideLoader(){ document.getElementById('loader').style.display='none'; }
        function showModal(h){ document.getElementById('modal-content').innerHTML=h; document.getElementById('generic-modal').style.display='flex'; }
        function closeModal(){ document.getElementById('generic-modal').style.display='none'; }

        // Auth
        function toggleAuth(){ isReg=!isReg; document.getElementById('reg-fields').style.display=isReg?'block':'none'; }
        function auth(){ const e=document.getElementById('email').value, p=document.getElementById('pass').value; if(isReg) socket.emit('register', {name:document.getElementById('reg-name').value, email:e, password:p}); else socket.emit('login', {email:e, password:p}); }
        socket.on('auth_success', (u)=>{ 
            currentUser=u; localStorage.setItem('u', JSON.stringify({email:u.email, password:u.password})); 
            document.getElementById('auth-modal').style.display='none'; hideLoader(); updateMyUI(); 
            navTo('home', document.querySelector('.nav-item'));
        });
        function updateMyUI(){ 
            document.getElementById('my-avatar').src=currentUser.avatar; 
            document.getElementById('header-avatar').src=currentUser.avatar;
            document.getElementById('user-coins').innerText=currentUser.coins;
        }

        // Economy (Gifts)
        function showGifts() {
            document.getElementById('gift-balance').innerText = currentUser.coins;
            document.getElementById('gift-modal').style.display = 'flex';
        }
        function sendGift(name, cost, icon) {
            if(currentUser.coins < cost) { notify('Ø®Ø·Ø£', 'Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ!'); return; }
            socket.emit('send_gift', { from: currentUser.email, to: currentPriv, giftName: name, cost: cost, icon: icon });
            document.getElementById('gift-modal').style.display = 'none';
        }
        socket.on('update_coins', (c) => { currentUser.coins = c; document.getElementById('user-coins').innerText = c; sndCoin.play(); });

        // Chat
        function switchChat(t) { ['global','private'].forEach(x=>document.getElementById(`chat-${x}`).style.display=x===t?'flex':'none'); document.querySelectorAll('.chat-tab').forEach(x=>x.classList.remove('active')); document.getElementById(`tab-${t}`).classList.add('active'); }
        function sendGlobal(){ const t=document.getElementById('g-input').value; if(t){socket.emit('send_global_msg',{text:t,author:currentUser.name,email:currentUser.email,avatar:currentUser.avatar});document.getElementById('g-input').value='';} }
        socket.on('receive_global_msg', (m)=>{ 
            const me=m.email===currentUser.email; 
            document.getElementById('g-msgs').innerHTML+=`<div style="display:flex;flex-direction:column;align-items:${me?'flex-start':'flex-end'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}"><b>${me?'':m.author+':'}</b> ${m.text}</div></div>`; 
        });

        // Private
        socket.on('update_friends', (f) => {
            document.getElementById('friends-list-view').innerHTML = f.map(u => `<div class="card" style="display:flex; gap:10px; align-items:center; cursor:pointer" onclick="startChat('${u.email}','${u.name}')"><img src="${u.avatar}" class="avatar"><div><b>${u.name}</b><br><small style="color:${u.isOnline?'#10b981':'#aaa'}">${u.isOnline?'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†':'ØºÙŠØ± Ù…ØªØµÙ„'}</small></div></div>`).join('');
        });
        window.startChat = (e, n) => { currentPriv=e; navTo('chat'); switchChat('private'); document.getElementById('friends-list-view').style.display='none'; document.getElementById('priv-convo').style.display='flex'; document.getElementById('p-name-header').innerText=n; document.getElementById('p-msgs').innerHTML=''; socket.emit('get_private_msgs',{u1:currentUser.email, u2:e}); }
        function closePriv(){ document.getElementById('priv-convo').style.display='none'; document.getElementById('friends-list-view').style.display='block'; currentPriv=null; }
        function sendPriv(){ const t=document.getElementById('p-input').value; if(t){ socket.emit('send_private_msg',{from:currentUser.email, to:currentPriv, text:t}); document.getElementById('p-input').value=''; } }
        
        socket.on('receive_private_msg', (m) => { 
            if(m.from===currentPriv || m.from===currentUser.email) {
                const me = m.from === currentUser.email;
                const content = m.isGift 
                    ? `<div class="gift-msg"><span class="gift-icon">${m.icon}</span>${m.text}</div>`
                    : m.text;
                document.getElementById('p-msgs').innerHTML+=`<div style="display:flex;flex-direction:column;align-items:${me?'flex-start':'flex-end'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}">${content}</div></div>`;
                sndMsg.play();
            } else {
                document.getElementById('msg-badge').style.display='block';
                notify('Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©', 'Ù„Ø¯ÙŠÙƒ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©');
            }
        });
        socket.on('load_private_msgs', (ms)=>{ 
            document.getElementById('p-msgs').innerHTML = ms.map(m=> {
                const me = m.from === currentUser.email;
                const content = m.isGift ? `<div class="gift-msg"><span class="gift-icon">${m.icon}</span>${m.text}</div>` : m.text;
                return `<div style="display:flex;flex-direction:column;align-items:${me?'flex-start':'flex-end'}"><div class="msg-bubble ${me?'msg-me':'msg-other'}">${content}</div></div>`;
            }).join(''); 
        });

        // Notification Event
        socket.on('notification', (d) => notify(d.title, d.body));

        // Profile (Unified)
        window.openProfile = (e) => { navTo('view-profile'); document.getElementById('profile-content').innerHTML='<h3 style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>'; socket.emit('get_profile_info', e); }
        socket.on('open_profile_view', ({user, posts}) => {
            document.getElementById('view-profile').innerHTML = `
                <div style="height:150px;background:linear-gradient(45deg,var(--primary),var(--accent));border-radius:0 0 30px 30px;position:relative;margin-bottom:60px">
                    <img src="${user.avatar}" class="avatar" style="width:100px;height:100px;border:5px solid var(--bg);position:absolute;bottom:-50px;right:50%;transform:translateX(50%)">
                </div>
                <div style="text-align:center"><h2>${user.name}</h2><p style="color:var(--gray)">${user.bio||''}</p></div>
                <div style="padding:15px">${posts.map(p=>`<div class="card"><p>${p.content||'ØµÙˆØ±Ø©'}</p></div>`).join('')}</div>
            `;
            navTo('profile');
        });

        // Posts
        let postImg=null; document.getElementById('post-img').addEventListener('change', function(){ const f=this.files[0]; if(f){const r=new FileReader(); r.onload=(e)=>{postImg=e.target.result;}; r.readAsDataURL(f);} });
        function publishPost(){ const t=document.getElementById('post-txt').value; if(t||postImg){ showLoader('Ù†Ø´Ø±...'); socket.emit('new_post', {content:t, media:postImg, author:currentUser.name, email:currentUser.email, avatar:currentUser.avatar, context:'general', contextId:null}); document.getElementById('post-txt').value=''; postImg=null; } }
        socket.on('upload_complete', hideLoader);
        socket.on('receive_post', (p)=> { document.getElementById('feed').insertAdjacentHTML('afterbegin', `<div class="card"><div style="display:flex;gap:10px"><img src="${p.avatar}" class="avatar"><b>${p.author}</b></div><p>${p.content}</p>${p.media?`<img src="${p.media}" style="width:100%;border-radius:10px">`:''}</div>`); });
        socket.on('load_posts', (ps)=> { document.getElementById('feed').innerHTML=''; ps.reverse().forEach(p=>document.getElementById('feed').insertAdjacentHTML('afterbegin', `<div class="card"><div style="display:flex;gap:10px"><img src="${p.avatar}" class="avatar"><b>${p.author}</b></div><p>${p.content}</p>${p.media?`<img src="${p.media}" style="width:100%;border-radius:10px">`:''}</div>`)); });

        // Explore & Groups (Simplified for space)
        socket.on('init_data', (d)=>{ 
            document.getElementById('explore-content').innerHTML = d.groups.map(g=>`<div class="card"><b>${g.name}</b></div>`).join(''); 
            d.reels.forEach(r => document.getElementById('reels-container').innerHTML += `<div style="height:100%;display:flex;justify-content:center;background:black;border-bottom:1px solid #333"><video src="${r.url}" controls style="width:100%"></video></div>`);
        });
    </script>
</body>
        </html>
